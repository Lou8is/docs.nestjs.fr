"use strict";(self.webpackChunkdocs_nestjs_com=self.webpackChunkdocs_nestjs_com||[]).push([[2],{2:(S,v,r)=>{r.r(v),r.d(v,{SecurityModule:()=>q});var g=r(177),E=r(685),y=r(445),c=r(8050),e=r(4438),m=r(5119),l=r(4819),b=r(9909),p=r(2469),f=r(5663);const A=[{path:"authentication",component:(()=>{class t extends c.y{static \u0275fac=(()=>{let s;return function(o){return(s||(s=e.xGo(t)))(o||t)}})();static \u0275cmp=e.VBU({type:t,selectors:[["app-authentication"]],features:[e.Vt3],decls:529,vars:68,consts:[["contentReference",""],["app0c39771af807bf7567aa75fa29dc93e6530a844d",""],["app8538778ad1cb98095eee0ba9cb73e6df14c6f347",""],["appe6020cc7fe0b6d92c64f2f94184de0577b4ff871",""],["app08bf8dd804192c2421dd21ffdbd11bf7e72f28f9",""],["appd746718c92509ca8cb6faa15415ef8fd6242f30c",""],["app8cc696a07d3588b92697d5cfd289c90c996c32a4",""],["appa9a00dbfbca2a769ae504d20dd1015382ba25661",""],["appb52ee33daae85df3e6c5ab1d2b5b2c93d39b3781",""],["app91eb21643063528e9e75a8b32fcea694e2e94674",""],["app4622be67ef3134053b4b235f9c07dc4d326e3a63",""],[1,"content"],[1,"github-links"],["href","https://github.com/Lou8is/docs.nestjs.fr/edit/main/content/security/authentication.md","aria-label","Proposer des modifications","title","Proposer des modifications"],[1,"fas","fa-edit"],["id","authentification"],["rel","nofollow","target","_blank","href","https://tools.ietf.org/html/rfc6750"],["appAnchor","","id","cr\xe9er-un-module-dauthentification"],[1,"language-bash"],[1,"with-heading"],[1,"filename"],[1,"language-typescript"],["appAnchor","","id","impl\xe9mentation-du-point-dacc\xe8s-se-connecter"],[1,"Warning"],["rel","nofollow","target","_blank","href","https://github.com/kelektiv/node.bcrypt.js#readme"],[1,"info"],["routerLink","/techniques/validation"],["appAnchor","","id","jeton-jwt"],["rel","nofollow","target","_blank","href","https://github.com/nestjs/jwt"],["rel","nofollow","target","_blank","href","https://github.com/nestjs/jwt/blob/master/README.md"],["rel","nofollow","target","_blank","href","https://github.com/auth0/node-jsonwebtoken#usage"],["appAnchor","","id","mise-en-\u0153uvre-de-la-garde-dauthentification"],["appAnchor","","id","activer-lauthentification-globalement"],["href","/guards#liaison-des-gardes"],["href","/guards#mettre-en-place-lensemble"],["appAnchor","","id","int\xe9gration-de-passport"],["rel","nofollow","target","_blank","href","https://github.com/jaredhanson/passport"],["routerLink","/recipes/passport"],["appAnchor","","id","exemple"],["rel","nofollow","target","_blank","href","https://github.com/nestjs/nest/tree/master/sample/19-auth-jwt"]],template:function(n,o){if(1&n&&(e.j41(0,"div",11,0)(2,"div",12)(3,"a",13),e.nrm(4,"i",14),e.k0s()(),e.j41(5,"h3",15),e.EFF(6,"Authentification"),e.k0s(),e.j41(7,"p"),e.EFF(8,"L'authentification est un \xe9l\xe9ment "),e.j41(9,"strong"),e.EFF(10,"essentiel"),e.k0s(),e.EFF(11," de la plupart des applications. Il existe de nombreuses approches et strat\xe9gies diff\xe9rentes pour g\xe9rer l'authentification. L'approche adopt\xe9e pour un projet d\xe9pend des exigences particuli\xe8res de l'application. Ce chapitre pr\xe9sente plusieurs approches de l'authentification qui peuvent \xeatre adapt\xe9es \xe0 un grand nombre d'exigences diff\xe9rentes."),e.k0s(),e.j41(12,"p"),e.EFF(13,"Pr\xe9cisons nos exigences. Pour ce cas d'utilisation, les clients commenceront par s'authentifier \xe0 l'aide d'un nom d'utilisateur et d'un mot de passe. Une fois authentifi\xe9, le serveur \xe9mettra un JWT qui pourra \xeatre envoy\xe9 en tant que "),e.j41(14,"a",16),e.EFF(15,"bearer token"),e.k0s(),e.EFF(16," (litt\xe9ralement \"jeton porteur\") dans un en-t\xeate d'autorisation sur les requ\xeates ult\xe9rieures afin de prouver l'authentification. Nous allons \xe9galement cr\xe9er une route prot\xe9g\xe9e qui n'est accessible qu'aux requ\xeates contenant un JWT valide."),e.k0s(),e.j41(17,"p"),e.EFF(18,"Nous commencerons par la premi\xe8re exigence : l'authentification d'un utilisateur. Nous l'\xe9tendrons ensuite en \xe9mettant un JWT. Enfin, nous allons cr\xe9er une route prot\xe9g\xe9e qui v\xe9rifie que la requ\xeate contient un JWT valide."),e.k0s(),e.j41(19,"h4",17)(20,"span"),e.EFF(21,"Cr\xe9er un module d'authentification"),e.k0s()(),e.j41(22,"p"),e.EFF(23,"Nous allons commencer par g\xe9n\xe9rer un "),e.j41(24,"code"),e.EFF(25,"AuthModule"),e.k0s(),e.EFF(26," et dans celui-ci, un "),e.j41(27,"code"),e.EFF(28,"AuthService"),e.k0s(),e.EFF(29," et un "),e.j41(30,"code"),e.EFF(31,"AuthController"),e.k0s(),e.EFF(32,". Nous allons utiliser le "),e.j41(33,"code"),e.EFF(34,"AuthService"),e.k0s(),e.EFF(35," pour impl\xe9menter la logique d'authentification, et le "),e.j41(36,"code"),e.EFF(37,"AuthController"),e.k0s(),e.EFF(38," pour exposer les terminaux d'authentification."),e.k0s(),e.j41(39,"pre")(40,"code",18),e.EFF(41,"\n$ nest g module auth\n$ nest g controller auth\n$ nest g service auth\n"),e.k0s()(),e.j41(42,"p"),e.EFF(43,"Comme nous impl\xe9mentons le "),e.j41(44,"code"),e.EFF(45,"AuthService"),e.k0s(),e.EFF(46,", nous trouverons utile d'encapsuler les op\xe9rations des utilisateurs dans un "),e.j41(47,"code"),e.EFF(48,"UsersService"),e.k0s(),e.EFF(49,", donc g\xe9n\xe9rons ce module et ce service maintenant :"),e.k0s(),e.j41(50,"pre")(51,"code",18),e.EFF(52,"\n$ nest g module users\n$ nest g service users\n"),e.k0s()(),e.j41(53,"p"),e.EFF(54,"Remplacez le contenu par d\xe9faut de ces fichiers g\xe9n\xe9r\xe9s comme indiqu\xe9 ci-dessous. Pour notre exemple d'application, le "),e.j41(55,"code"),e.EFF(56,"UsersService"),e.k0s(),e.EFF(57," maintient simplement une liste d'utilisateurs en m\xe9moire cod\xe9e en dur, et une m\xe9thode de recherche pour r\xe9cup\xe9rer un utilisateur par son nom d'utilisateur. Dans une application r\xe9elle, c'est ici que vous construiriez votre mod\xe8le d'utilisateur et votre couche de persistance, en utilisant la biblioth\xe8que de votre choix (par exemple, TypeORM, Sequelize, Mongoose, etc.)."),e.k0s(),e.j41(58,"app-copy-button",19)(59,"span",20),e.EFF(60),e.nI1(61,"extension"),e.nrm(62,"app-tabs",null,1),e.k0s(),e.j41(64,"pre")(65,"code",21),e.EFF(66,"\nimport { Injectable } from '@nestjs/common';\n\n// Il doit s'agir d'une v\xe9ritable classe/interface repr\xe9sentant une entit\xe9 utilisateur.\nexport type User = any;\n\n@Injectable()\nexport class UsersService {\n  private readonly users = [\n    {\n      userId: 1,\n      username: 'john',\n      password: 'changeme',\n    },\n    {\n      userId: 2,\n      username: 'maria',\n      password: 'guess',\n    },\n  ];\n\n  async findOne(username: string): Promise<User | undefined> {\n    return this.users.find(user => user.username === username);\n  }\n}\n"),e.k0s()(),e.j41(67,"pre")(68,"code",21),e.EFF(69,"\nimport { Injectable } from '@nestjs/common';\n\n@Injectable()\nexport class UsersService {\n  constructor() {\n    this.users = [\n      {\n        userId: 1,\n        username: 'john',\n        password: 'changeme',\n      },\n      {\n        userId: 2,\n        username: 'maria',\n        password: 'guess',\n      },\n    ];\n  }\n\n  async findOne(username) {\n    return this.users.find(user => user.username === username);\n  }\n}\n"),e.k0s()()(),e.j41(70,"p"),e.EFF(71,"Dans le "),e.j41(72,"code"),e.EFF(73,"UsersModule"),e.k0s(),e.EFF(74,", le seul changement n\xe9cessaire est d'ajouter le "),e.j41(75,"code"),e.EFF(76,"UsersService"),e.k0s(),e.EFF(77," au tableau des exportations du d\xe9corateur "),e.j41(78,"code"),e.EFF(79,"@Module"),e.k0s(),e.EFF(80," afin qu'il soit visible en dehors de ce module (nous l'utiliserons bient\xf4t dans notre "),e.j41(81,"code"),e.EFF(82,"AuthService"),e.k0s(),e.EFF(83,")."),e.k0s(),e.j41(84,"app-copy-button",19)(85,"span",20),e.EFF(86),e.nI1(87,"extension"),e.nrm(88,"app-tabs",null,2),e.k0s(),e.j41(90,"pre")(91,"code",21),e.EFF(92,"\nimport { Module } from '@nestjs/common';\nimport { UsersService } from './users.service';\n\n@Module({\n  providers: [UsersService],\n  exports: [UsersService],\n})\nexport class UsersModule {}\n"),e.k0s()(),e.j41(93,"pre")(94,"code",21),e.EFF(95,"\nimport { Module } from '@nestjs/common';\nimport { UsersService } from './users.service';\n\n@Module({\n  providers: [UsersService],\n  exports: [UsersService],\n})\nexport class UsersModule {}\n"),e.k0s()()(),e.j41(96,"h4",22)(97,"span"),e.EFF(98,'Impl\xe9mentation du point d\'acc\xe8s "Se connecter"'),e.k0s()(),e.j41(99,"p"),e.EFF(100,"Notre "),e.j41(101,"code"),e.EFF(102,"AuthService"),e.k0s(),e.EFF(103," a pour t\xe2che de r\xe9cup\xe9rer un utilisateur et de v\xe9rifier son mot de passe. Nous cr\xe9ons une m\xe9thode "),e.j41(104,"code"),e.EFF(105,"signIn()"),e.k0s(),e.EFF(106," dans ce but. Dans le code ci-dessous, nous utilisons un op\xe9rateur d'\xe9talement ES6 pratique pour retirer la propri\xe9t\xe9 password de l'objet user avant de le renvoyer. Il s'agit d'une pratique courante lors du retour d'objets utilisateurs, car vous ne souhaitez pas exposer des champs sensibles tels que des mots de passe ou d'autres cl\xe9s de s\xe9curit\xe9."),e.k0s(),e.j41(107,"app-copy-button",19)(108,"span",20),e.EFF(109),e.nI1(110,"extension"),e.nrm(111,"app-tabs",null,3),e.k0s(),e.j41(113,"pre")(114,"code",21),e.EFF(115,"\nimport { Injectable, UnauthorizedException } from '@nestjs/common';\nimport { UsersService } from '../users/users.service';\n\n@Injectable()\nexport class AuthService {\n  constructor(private usersService: UsersService) {}\n\n  async signIn(username: string, pass: string): Promise<any> {\n    const user = await this.usersService.findOne(username);\n    if (user?.password !== pass) {\n      throw new UnauthorizedException();\n    }\n    const { password, ...result } = user;\n    // TODO : G\xe9n\xe9rer un JWT et le renvoyer ici\n    // au lieu de l'objet utilisateur\n    return result;\n  }\n}\n"),e.k0s()(),e.j41(116,"pre")(117,"code",21),e.EFF(118,"\nimport { Injectable, Dependencies, UnauthorizedException } from '@nestjs/common';\nimport { UsersService } from '../users/users.service';\n\n@Injectable()\n@Dependencies(UsersService)\nexport class AuthService {\n  constructor(usersService) {\n    this.usersService = usersService;\n  }\n\n  async signIn(username: string, pass: string) {\n    const user = await this.usersService.findOne(username);\n    if (user?.password !== pass) {\n      throw new UnauthorizedException();\n    }\n    const { password, ...result } = user;\n    // TODO : G\xe9n\xe9rer un JWT et le renvoyer ici\n    // au lieu de l'objet utilisateur\n    return result;\n  }\n}\n"),e.k0s()()(),e.j41(119,"blockquote",23)(120,"strong"),e.EFF(121,"Attention"),e.k0s(),e.EFF(122," Bien entendu, dans une application r\xe9elle, vous ne stockeriez pas un mot de passe en texte brut. Vous utiliseriez plut\xf4t une biblioth\xe8que comme "),e.j41(123,"a",24),e.EFF(124,"bcrypt"),e.k0s(),e.EFF(125,", avec un algorithme de hachage \xe0 sens unique avec salage. Avec cette approche, vous ne stockeriez que des mots de passe hach\xe9s, et compareriez ensuite le mot de passe stock\xe9 \xe0 une version hach\xe9e du mot de passe "),e.j41(126,"strong"),e.EFF(127,"entrant"),e.k0s(),e.EFF(128,", ne stockant ou n'exposant donc jamais les mots de passe des utilisateurs en texte brut. Pour que notre exemple d'application reste simple, nous violons cette r\xe8gle absolue et utilisons du texte en clair. "),e.j41(129,"strong"),e.EFF(130,"Ne faites pas cela dans votre application r\xe9elle !"),e.k0s()(),e.j41(131,"p"),e.EFF(132,"Maintenant, nous mettons \xe0 jour notre "),e.j41(133,"code"),e.EFF(134,"AuthModule"),e.k0s(),e.EFF(135," pour importer le "),e.j41(136,"code"),e.EFF(137,"UsersModule"),e.k0s(),e.EFF(138,"."),e.k0s(),e.j41(139,"app-copy-button",19)(140,"span",20),e.EFF(141),e.nI1(142,"extension"),e.nrm(143,"app-tabs",null,4),e.k0s(),e.j41(145,"pre")(146,"code",21),e.EFF(147,"\nimport { Module } from '@nestjs/common';\nimport { AuthService } from './auth.service';\nimport { AuthController } from './auth.controller';\nimport { UsersModule } from '../users/users.module';\n\n@Module({\n  imports: [UsersModule],\n  providers: [AuthService],\n  controllers: [AuthController],\n})\nexport class AuthModule {}\n"),e.k0s()(),e.j41(148,"pre")(149,"code",21),e.EFF(150,"\nimport { Module } from '@nestjs/common';\nimport { AuthService } from './auth.service';\nimport { AuthController } from './auth.controller';\nimport { UsersModule } from '../users/users.module';\n\n@Module({\n  imports: [UsersModule],\n  providers: [AuthService],\n  controllers: [AuthController],\n})\nexport class AuthModule {}\n"),e.k0s()()(),e.j41(151,"p"),e.EFF(152,"Avec ceci en place, ouvrons le "),e.j41(153,"code"),e.EFF(154,"AuthController"),e.k0s(),e.EFF(155," et ajoutons lui une m\xe9thode "),e.j41(156,"code"),e.EFF(157,"signIn()"),e.k0s(),e.EFF(158,". Cette m\xe9thode sera appel\xe9e par le client pour authentifier un utilisateur. Elle recevra le nom d'utilisateur et le mot de passe dans le corps de la requ\xeate, et retournera un jeton JWT si l'utilisateur est authentifi\xe9."),e.k0s(),e.j41(159,"app-copy-button",19)(160,"span",20),e.EFF(161),e.nI1(162,"extension"),e.nrm(163,"app-tabs",null,5),e.k0s(),e.j41(165,"pre")(166,"code",21),e.EFF(167,"\nimport { Body, Controller, Post, HttpCode, HttpStatus } from '@nestjs/common';\nimport { AuthService } from './auth.service';\n\n@Controller('auth')\nexport class AuthController {\n  constructor(private authService: AuthService) {}\n\n  @HttpCode(HttpStatus.OK)\n  @Post('login')\n  signIn(@Body() signInDto: Record<string, any>) {\n    return this.authService.signIn(signInDto.username, signInDto.password);\n  }\n}\n"),e.k0s()()(),e.j41(168,"blockquote",25)(169,"strong"),e.EFF(170,"Astuce"),e.k0s(),e.EFF(171," Id\xe9alement, au lieu d'utiliser le type "),e.j41(172,"code"),e.EFF(173,"Record<string, any>"),e.k0s(),e.EFF(174,", nous devrions utiliser une classe DTO pour d\xe9finir la forme du corps de la requ\xeate. Voir le chapitre "),e.j41(175,"a",26),e.EFF(176,"validation"),e.k0s(),e.EFF(177," pour plus d'informations.\n"),e.k0s(),e.j41(178,"p"),e.nrm(179,"app-banner-courses-auth"),e.k0s(),e.j41(180,"h4",27)(181,"span"),e.EFF(182,"Jeton JWT"),e.k0s()(),e.j41(183,"p"),e.EFF(184,"Nous sommes pr\xeats \xe0 passer \xe0 la partie JWT de notre syst\xe8me d'authentification. Passons en revue et affinons nos exigences :"),e.k0s(),e.j41(185,"ul")(186,"li"),e.EFF(187,"Permettre aux utilisateurs de s'authentifier avec leur nom d'utilisateur et leur mot de passe, en renvoyant un JWT \xe0 utiliser lors d'appels ult\xe9rieurs \xe0 des points d'extr\xe9mit\xe9 d'API prot\xe9g\xe9s. Nous sommes sur la bonne voie pour r\xe9pondre \xe0 cette exigence. Pour la compl\xe9ter, nous devons \xe9crire le code qui \xe9met un JWT."),e.k0s(),e.j41(188,"li"),e.EFF(189,"Cr\xe9er des itin\xe9raires API prot\xe9g\xe9s en fonction de la pr\xe9sence d'un JWT valide en tant que jeton porteur."),e.k0s()(),e.j41(190,"p"),e.EFF(191,"Nous devrons installer un package suppl\xe9mentaire pour r\xe9pondre \xe0 nos besoins en mati\xe8re de JWT :"),e.k0s(),e.j41(192,"pre")(193,"code",18),e.EFF(194,"\n$ npm install --save @nestjs/jwt\n"),e.k0s()(),e.j41(195,"blockquote",25)(196,"strong"),e.EFF(197,"Astuce"),e.k0s(),e.EFF(198," Le package "),e.j41(199,"code"),e.EFF(200,"@nestjs/jwt"),e.k0s(),e.EFF(201," (voir plus "),e.j41(202,"a",28),e.EFF(203,"ici"),e.k0s(),e.EFF(204,") est un package utilitaire qui aide \xe0 la manipulation des JWT. Cela inclut la g\xe9n\xe9ration et la v\xe9rification des jetons JWT.\n"),e.k0s(),e.j41(205,"p"),e.EFF(206,"Pour garder nos services modulaires de mani\xe8re propre, nous allons nous occuper de la g\xe9n\xe9ration du JWT dans le "),e.j41(207,"code"),e.EFF(208,"authService"),e.k0s(),e.EFF(209,". Ouvrez le fichier "),e.j41(210,"code"),e.EFF(211,"auth.service.ts"),e.k0s(),e.EFF(212," dans le dossier "),e.j41(213,"code"),e.EFF(214,"auth"),e.k0s(),e.EFF(215,", injectez le "),e.j41(216,"code"),e.EFF(217,"JwtService"),e.k0s(),e.EFF(218,", et mettez \xe0 jour la m\xe9thode "),e.j41(219,"code"),e.EFF(220,"signIn"),e.k0s(),e.EFF(221," pour g\xe9n\xe9rer un jeton JWT comme montr\xe9 ci-dessous :"),e.k0s(),e.j41(222,"app-copy-button",19)(223,"span",20),e.EFF(224),e.nI1(225,"extension"),e.nrm(226,"app-tabs",null,6),e.k0s(),e.j41(228,"pre")(229,"code",21),e.EFF(230,"\nimport { Injectable, UnauthorizedException } from '@nestjs/common';\nimport { UsersService } from '../users/users.service';\nimport { JwtService } from '@nestjs/jwt';\n\n@Injectable()\nexport class AuthService {\n  constructor(\n    private usersService: UsersService,\n    private jwtService: JwtService\n  ) {}\n\n    async signIn(\n    username: string,\n    pass: string,\n  ): Promise<{ access_token: string }> {\n    const user = await this.usersService.findOne(username);\n    if (user?.password !== pass) {\n      throw new UnauthorizedException();\n    }\n    const payload = { sub: user.userId, username: user.username };\n    return {\n      access_token: await this.jwtService.signAsync(payload),\n    };\n  }\n}\n"),e.k0s()(),e.j41(231,"pre")(232,"code",21),e.EFF(233,"\nimport { Injectable, Dependencies, UnauthorizedException } from '@nestjs/common';\nimport { UsersService } from '../users/users.service';\nimport { JwtService } from '@nestjs/jwt';\n\n@Dependencies(UsersService, JwtService)\n@Injectable()\nexport class AuthService {\n  constructor(usersService, jwtService) {\n    this.usersService = usersService;\n    this.jwtService = jwtService;\n  }\n\n  async signIn(username, pass) {\n    const user = await this.usersService.findOne(username);\n    if (user?.password !== pass) {\n      throw new UnauthorizedException();\n    }\n    const payload = { username: user.username, sub: user.userId };\n    return {\n      access_token: await this.jwtService.signAsync(payload),\n    };\n  }\n}\n"),e.k0s()()(),e.j41(234,"p"),e.EFF(235,"Nous utilisons la librairie "),e.j41(236,"code"),e.EFF(237,"@nestjs/jwt"),e.k0s(),e.EFF(238,", qui fournit une fonction "),e.j41(239,"code"),e.EFF(240,"signAsync()"),e.k0s(),e.EFF(241," pour g\xe9n\xe9rer notre JWT \xe0 partir d'un sous-ensemble de propri\xe9t\xe9s de l'objet "),e.j41(242,"code"),e.EFF(243,"user"),e.k0s(),e.EFF(244,", que nous retournons ensuite comme un simple objet avec une seule propri\xe9t\xe9 "),e.j41(245,"code"),e.EFF(246,"access_token"),e.k0s(),e.EFF(247,". Note : nous avons choisi le nom de propri\xe9t\xe9 "),e.j41(248,"code"),e.EFF(249,"sub"),e.k0s(),e.EFF(250," pour contenir notre valeur "),e.j41(251,"code"),e.EFF(252,"userId"),e.k0s(),e.EFF(253," afin d'\xeatre coh\xe9rent avec les standards JWT."),e.k0s(),e.j41(254,"p"),e.EFF(255,"Nous devons maintenant mettre \xe0 jour le "),e.j41(256,"code"),e.EFF(257,"AuthModule"),e.k0s(),e.EFF(258," pour importer les nouvelles d\xe9pendances et configurer le "),e.j41(259,"code"),e.EFF(260,"JwtModule"),e.k0s(),e.EFF(261,"."),e.k0s(),e.j41(262,"p"),e.EFF(263,"Tout d'abord, cr\xe9ez "),e.j41(264,"code"),e.EFF(265,"constants.ts"),e.k0s(),e.EFF(266," dans le dossier "),e.j41(267,"code"),e.EFF(268,"auth"),e.k0s(),e.EFF(269,", et ajoutez le code suivant :"),e.k0s(),e.j41(270,"app-copy-button",19)(271,"span",20),e.EFF(272),e.nI1(273,"extension"),e.nrm(274,"app-tabs",null,7),e.k0s(),e.j41(276,"pre")(277,"code",21),e.EFF(278,"\nexport const jwtConstants = {\n  secret: 'N UTILISEZ PAS CETTE VALEUR. CR\xc9EZ PLUT\xd4T UN SECRET COMPLEXE ET GARDEZ-LE EN S\xc9CURIT\xc9 EN DEHORS DU CODE SOURCE.',\n};\n"),e.k0s()(),e.j41(279,"pre")(280,"code",21),e.EFF(281,"\nexport const jwtConstants = {\n  secret: 'N UTILISEZ PAS CETTE VALEUR. CR\xc9EZ PLUT\xd4T UN SECRET COMPLEXE ET GARDEZ-LE EN S\xc9CURIT\xc9 EN DEHORS DU CODE SOURCE.',\n};\n"),e.k0s()()(),e.j41(282,"p"),e.EFF(283,"Nous l'utiliserons pour partager notre cl\xe9 entre les \xe9tapes de signature et de v\xe9rification du JWT."),e.k0s(),e.j41(284,"blockquote",23)(285,"strong"),e.EFF(286,"Attention"),e.k0s(),e.j41(287,"strong"),e.EFF(288,"Ne pas exposer cette cl\xe9 publiquement"),e.k0s(),e.EFF(289,". Nous l'avons fait ici pour que le code soit clair, mais dans un syst\xe8me de production "),e.j41(290,"strong"),e.EFF(291,"vous devez prot\xe9ger cette cl\xe9"),e.k0s(),e.EFF(292," en utilisant des mesures appropri\xe9es telles qu'un coffre-fort de secrets, une variable d'environnement ou un service de configuration.\n"),e.k0s(),e.j41(293,"p"),e.EFF(294,"Maintenant, ouvrez "),e.j41(295,"code"),e.EFF(296,"auth.module.ts"),e.k0s(),e.EFF(297," dans le dossier "),e.j41(298,"code"),e.EFF(299,"auth"),e.k0s(),e.EFF(300," et mettez-le \xe0 jour pour qu'il ressemble \xe0 ceci :"),e.k0s(),e.j41(301,"app-copy-button",19)(302,"span",20),e.EFF(303),e.nI1(304,"extension"),e.nrm(305,"app-tabs",null,8),e.k0s(),e.j41(307,"pre")(308,"code",21),e.EFF(309,"\nimport { Module } from '@nestjs/common';\nimport { AuthService } from './auth.service';\nimport { UsersModule } from '../users/users.module';\nimport { JwtModule } from '@nestjs/jwt';\nimport { AuthController } from './auth.controller';\nimport { jwtConstants } from './constants';\n\n@Module({\n  imports: [\n    UsersModule,\n    JwtModule.register({\n      global: true,\n      secret: jwtConstants.secret,\n      signOptions: { expiresIn: '60s' },\n    }),\n  ],\n  providers: [AuthService],\n  controllers: [AuthController],\n  exports: [AuthService],\n})\nexport class AuthModule {}\n"),e.k0s()(),e.j41(310,"pre")(311,"code",21),e.EFF(312,"\nimport { Module } from '@nestjs/common';\nimport { AuthService } from './auth.service';\nimport { UsersModule } from '../users/users.module';\nimport { JwtModule } from '@nestjs/jwt';\nimport { AuthController } from './auth.controller';\nimport { jwtConstants } from './constants';\n\n@Module({\n  imports: [\n    UsersModule,\n    JwtModule.register({\n      global: true,\n      secret: jwtConstants.secret,\n      signOptions: { expiresIn: '60s' },\n    }),\n  ],\n  providers: [AuthService],\n  controllers: [AuthController],\n  exports: [AuthService],\n})\nexport class AuthModule {}\n"),e.k0s()()(),e.j41(313,"blockquote",25)(314,"strong"),e.EFF(315,"Astuce"),e.k0s(),e.EFF(316," Nous enregistrons le "),e.j41(317,"code"),e.EFF(318,"JwtModule"),e.k0s(),e.EFF(319," comme global pour nous faciliter la t\xe2che. Cela signifie que nous n'avons pas besoin d'importer le "),e.j41(320,"code"),e.EFF(321,"JwtModule"),e.k0s(),e.EFF(322," ailleurs dans notre application.\n"),e.k0s(),e.j41(323,"p"),e.EFF(324,"Nous configurons le "),e.j41(325,"code"),e.EFF(326,"JwtModule"),e.k0s(),e.EFF(327," en utilisant "),e.j41(328,"code"),e.EFF(329,"register()"),e.k0s(),e.EFF(330,", en passant un objet de configuration. Voir "),e.j41(331,"a",29),e.EFF(332,"ici"),e.k0s(),e.EFF(333," pour plus de d\xe9tails sur le Nest "),e.j41(334,"code"),e.EFF(335,"JwtModule"),e.k0s(),e.EFF(336," et "),e.j41(337,"a",30),e.EFF(338,"ici"),e.k0s(),e.EFF(339," pour plus de d\xe9tails sur les options de configuration disponibles."),e.k0s(),e.j41(340,"p"),e.EFF(341,"Testons \xe0 nouveau nos routes en utilisant cURL. Vous pouvez tester avec n'importe quel objet "),e.j41(342,"code"),e.EFF(343,"user"),e.k0s(),e.EFF(344," cod\xe9 en dur dans le "),e.j41(345,"code"),e.EFF(346,"UsersService"),e.k0s(),e.EFF(347,"."),e.k0s(),e.j41(348,"pre")(349,"code",18),e.EFF(350,'\n$ # POST vers /auth/login\n$ curl -X POST http://localhost:3000/auth/login -d \'{"username": "john", "password": "changeme"}\' -H "Content-Type: application/json"\n{"access_token":"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."}\n$ # Note : le JWT ci-dessus a \xe9t\xe9 tronqu\xe9.\n'),e.k0s()(),e.j41(351,"h4",31)(352,"span"),e.EFF(353,"Mise en \u0153uvre de la garde d'authentification"),e.k0s()(),e.j41(354,"p"),e.EFF(355,"Nous pouvons maintenant aborder notre derni\xe8re exigence : prot\xe9ger les endpoints en exigeant qu'un JWT valide soit pr\xe9sent dans la requ\xeate. Nous allons le faire en cr\xe9ant une "),e.j41(356,"code"),e.EFF(357,"AuthGuard"),e.k0s(),e.EFF(358," que nous pourrons utiliser pour prot\xe9ger nos routes."),e.k0s(),e.j41(359,"app-copy-button",19)(360,"span",20),e.EFF(361),e.nI1(362,"extension"),e.nrm(363,"app-tabs",null,9),e.k0s(),e.j41(365,"pre")(366,"code",21),e.EFF(367,"\nimport {\n  CanActivate,\n  ExecutionContext,\n  Injectable,\n  UnauthorizedException,\n} from '@nestjs/common';\nimport { JwtService } from '@nestjs/jwt';\nimport { jwtConstants } from './constants';\nimport { Request } from 'express';\n\n@Injectable()\nexport class AuthGuard implements CanActivate {\n  constructor(private jwtService: JwtService) {}\n\n  async canActivate(context: ExecutionContext): Promise<boolean> {\n    const request = context.switchToHttp().getRequest();\n    const token = this.extractTokenFromHeader(request);\n    if (!token) {\n      throw new UnauthorizedException();\n    }\n    try {\n      const payload = await this.jwtService.verifyAsync(\n        token,\n        {\n          secret: jwtConstants.secret\n        }\n      );\n      // \u{1f4a1} Nous attribuons ici le payload \xe0 l'objet de la requ\xeate\n      // afin que nous puissions y acc\xe9der dans nos gestionnaires de routes\n      request['user'] = payload;\n    } catch {\n      throw new UnauthorizedException();\n    }\n    return true;\n  }\n\n  private extractTokenFromHeader(request: Request): string | undefined {\n    const [type, token] = request.headers.authorization?.split(' ') ?? [];\n    return type === 'Bearer' ? token : undefined;\n  }\n}\n"),e.k0s()()(),e.j41(368,"p"),e.EFF(369,"Nous pouvons maintenant impl\xe9menter notre route prot\xe9g\xe9e et enregistrer notre "),e.j41(370,"code"),e.EFF(371,"AuthGuard"),e.k0s(),e.EFF(372," pour la prot\xe9ger."),e.k0s(),e.j41(373,"p"),e.EFF(374,"Ouvrez le fichier "),e.j41(375,"code"),e.EFF(376,"auth.controller.ts"),e.k0s(),e.EFF(377," et mettez-le \xe0 jour comme indiqu\xe9 ci-dessous :"),e.k0s(),e.j41(378,"app-copy-button",19)(379,"span",20),e.EFF(380),e.nI1(381,"extension"),e.nrm(382,"app-tabs",null,10),e.k0s(),e.j41(384,"pre")(385,"code",21),e.EFF(386,"\nimport {\n  Body,\n  Controller,\n  Get,\n  HttpCode,\n  HttpStatus,\n  Post,\n  Request,\n  UseGuards\n} from '@nestjs/common';\nimport { AuthGuard } from './auth.guard';\nimport { AuthService } from './auth.service';\n\n@Controller('auth')\nexport class AuthController {\n  constructor(private authService: AuthService) {}\n\n  @HttpCode(HttpStatus.OK)\n  @Post('login')\n  signIn(@Body() signInDto: Record<string, any>) {\n    return this.authService.signIn(signInDto.username, signInDto.password);\n  }\n\n  @UseGuards(AuthGuard)\n  @Get('profile')\n  getProfile(@Request() req) {\n    return req.user;\n  }\n}\n"),e.k0s()()(),e.j41(387,"p"),e.EFF(388,"Nous appliquons le "),e.j41(389,"code"),e.EFF(390,"AuthGuard"),e.k0s(),e.EFF(391," que nous venons de cr\xe9er \xe0 la route "),e.j41(392,"code"),e.EFF(393,"GET /profile"),e.k0s(),e.EFF(394," afin qu'elle soit prot\xe9g\xe9e."),e.k0s(),e.j41(395,"p"),e.EFF(396,"Assurez-vous que l'application est lanc\xe9e, et testez les routes en utilisant "),e.j41(397,"code"),e.EFF(398,"cURL"),e.k0s(),e.EFF(399,"."),e.k0s(),e.j41(400,"pre")(401,"code",18),e.EFF(402,'\n$ # GET /profile\n$ curl http://localhost:3000/auth/profile\n{"statusCode":401,"message":"Unauthorized"}\n\n$ # POST /auth/login\n$ curl -X POST http://localhost:3000/auth/login -d \'{"username": "john", "password": "changeme"}\' -H "Content-Type: application/json"\n{"access_token":"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2Vybm..."}\n\n$ # GET /profile en utilisant le jeton d\'acc\xe8s (access_token) renvoy\xe9 \xe0 l\'\xe9tape pr\xe9c\xe9dente comme jeton porteur\n$ curl http://localhost:3000/auth/profile -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2Vybm..."\n{"sub":1,"username":"john","iat":...,"exp":...}\n'),e.k0s()(),e.j41(403,"p"),e.EFF(404,"Notez que dans le "),e.j41(405,"code"),e.EFF(406,"AuthModule"),e.k0s(),e.EFF(407,", nous avons configur\xe9 le JWT pour avoir une expiration de "),e.j41(408,"code"),e.EFF(409,"60 seconds"),e.k0s(),e.EFF(410,". C'est une expiration trop courte, et traiter les d\xe9tails de l'expiration et du rafra\xeechissement des jetons d\xe9passe le cadre de cet article. Cependant, nous avons choisi cela pour d\xe9montrer une qualit\xe9 importante des JWTs. Si vous attendez 60 secondes apr\xe8s l'authentification avant de tenter une requ\xeate "),e.j41(411,"code"),e.EFF(412,"GET /auth/profile"),e.k0s(),e.EFF(413,", vous recevrez une r\xe9ponse "),e.j41(414,"code"),e.EFF(415,"401 Unauthorized"),e.k0s(),e.EFF(416,". C'est parce que "),e.j41(417,"code"),e.EFF(418,"@nestjs/jwt"),e.k0s(),e.EFF(419," v\xe9rifie automatiquement le d\xe9lai d'expiration du JWT, vous \xe9vitant ainsi d'avoir \xe0 le faire dans votre application."),e.k0s(),e.j41(420,"p"),e.EFF(421,"Nous avons maintenant termin\xe9 la mise en \u0153uvre de l'authentification JWT. Les clients JavaScript (tels que Angular/React/Vue) et autres applications JavaScript peuvent d\xe9sormais s'authentifier et communiquer en toute s\xe9curit\xe9 avec notre serveur API."),e.k0s(),e.j41(422,"h4",32)(423,"span"),e.EFF(424,"Activer l'authentification globalement"),e.k0s()(),e.j41(425,"p"),e.EFF(426,"Si la grande majorit\xe9 de vos points d'acc\xe8s doivent \xeatre prot\xe9g\xe9s par d\xe9faut, vous pouvez enregistrer la garde d'authentification comme une "),e.j41(427,"a",33),e.EFF(428,"garde globale"),e.k0s(),e.EFF(429," et au lieu d'utiliser le d\xe9corateur "),e.j41(430,"code"),e.EFF(431,"@UseGuards()"),e.k0s(),e.EFF(432," au-dessus de chaque contr\xf4leur, vous pouvez simplement indiquer quelles routes doivent \xeatre publiques."),e.k0s(),e.j41(433,"p"),e.EFF(434,"Tout d'abord, enregistrez le "),e.j41(435,"code"),e.EFF(436,"AuthGuard"),e.k0s(),e.EFF(437," en tant que garde globale en utilisant la construction suivante (dans n'importe quel module, par exemple, dans le "),e.j41(438,"code"),e.EFF(439,"AuthModule"),e.k0s(),e.EFF(440,") :"),e.k0s(),e.j41(441,"app-copy-button")(442,"pre")(443,"code",21),e.EFF(444,"\nproviders: [\n  {\n    provide: APP_GUARD,\n    useClass: AuthGuard,\n  },\n],\n"),e.k0s()()(),e.j41(445,"p"),e.EFF(446,"Avec ceci en place, Nest va automatiquement lier "),e.j41(447,"code"),e.EFF(448,"AuthGuard"),e.k0s(),e.EFF(449," \xe0 tous les endpoints."),e.k0s(),e.j41(450,"p"),e.EFF(451,"Nous devons maintenant fournir un m\xe9canisme pour d\xe9clarer les routes comme publiques. Pour cela, nous pouvons cr\xe9er un d\xe9corateur personnalis\xe9 en utilisant la fonction d'usine de d\xe9corateur "),e.j41(452,"code"),e.EFF(453,"SetMetadata"),e.k0s(),e.EFF(454,"."),e.k0s(),e.j41(455,"app-copy-button")(456,"pre")(457,"code",21),e.EFF(458,"\nimport { SetMetadata } from '@nestjs/common';\n\nexport const IS_PUBLIC_KEY = 'isPublic';\nexport const Public = () => SetMetadata(IS_PUBLIC_KEY, true);\n"),e.k0s()()(),e.j41(459,"p"),e.EFF(460,"Dans le fichier ci-dessus, nous avons export\xe9 deux constantes. L'une est notre cl\xe9 de m\xe9tadonn\xe9es nomm\xe9e "),e.j41(461,"code"),e.EFF(462,"IS_PUBLIC_KEY"),e.k0s(),e.EFF(463,", et l'autre est notre nouveau d\xe9corateur que nous allons appeler "),e.j41(464,"code"),e.EFF(465,"Public"),e.k0s(),e.EFF(466," (vous pouvez alternativement le nommer "),e.j41(467,"code"),e.EFF(468,"SkipAuth"),e.k0s(),e.EFF(469," ou "),e.j41(470,"code"),e.EFF(471,"AllowAnon"),e.k0s(),e.EFF(472,", selon ce qui convient \xe0 votre projet)."),e.k0s(),e.j41(473,"p"),e.EFF(474,"Maintenant que nous avons un d\xe9corateur personnalis\xe9 "),e.j41(475,"code"),e.EFF(476,"@Public()"),e.k0s(),e.EFF(477,", nous pouvons l'utiliser pour d\xe9corer n'importe quelle m\xe9thode, comme suit :"),e.k0s(),e.j41(478,"app-copy-button")(479,"pre")(480,"code",21),e.EFF(481,"\n@Public()\n@Get()\nfindAll() {\n  return [];\n}\n"),e.k0s()()(),e.j41(482,"p"),e.EFF(483,"Enfin, nous avons besoin que le "),e.j41(484,"code"),e.EFF(485,"AuthGuard"),e.k0s(),e.EFF(486," retourne "),e.j41(487,"code"),e.EFF(488,"true"),e.k0s(),e.EFF(489," lorsque la m\xe9tadonn\xe9e "),e.j41(490,"code"),e.EFF(491,'"isPublic"'),e.k0s(),e.EFF(492," est trouv\xe9e. Pour cela, nous allons utiliser la classe "),e.j41(493,"code"),e.EFF(494,"Reflector"),e.k0s(),e.EFF(495," (en lire plus "),e.j41(496,"a",34),e.EFF(497,"ici"),e.k0s(),e.EFF(498,")."),e.k0s(),e.j41(499,"app-copy-button")(500,"pre")(501,"code",21),e.EFF(502,"\n@Injectable()\nexport class AuthGuard implements CanActivate {\n  constructor(private jwtService: JwtService, private reflector: Reflector) {}\n\n  async canActivate(context: ExecutionContext): Promise<boolean> {\n    const isPublic = this.reflector.getAllAndOverride<boolean>(IS_PUBLIC_KEY, [\n      context.getHandler(),\n      context.getClass(),\n    ]);\n    if (isPublic) {\n      // \u{1f4a1} Voir cette condition\n      return true;\n    }\n\n    const request = context.switchToHttp().getRequest();\n    const token = this.extractTokenFromHeader(request);\n    if (!token) {\n      throw new UnauthorizedException();\n    }\n    try {\n      const payload = await this.jwtService.verifyAsync(token, {\n        secret: jwtConstants.secret,\n      });\n      // \u{1f4a1} Nous attribuons ici le payload \xe0 l'objet de la requ\xeate\n      // afin que nous puissions y acc\xe9der dans nos gestionnaires de routes\n      request['user'] = payload;\n    } catch {\n      throw new UnauthorizedException();\n    }\n    return true;\n  }\n\n  private extractTokenFromHeader(request: Request): string | undefined {\n    const [type, token] = request.headers.authorization?.split(' ') ?? [];\n    return type === 'Bearer' ? token : undefined;\n  }\n}\n"),e.k0s()()(),e.j41(503,"h4",35)(504,"span"),e.EFF(505,"Int\xe9gration de Passport"),e.k0s()(),e.j41(506,"p")(507,"a",36),e.EFF(508,"Passport"),e.k0s(),e.EFF(509," est la biblioth\xe8que d'authentification node.js la plus populaire, bien connue de la communaut\xe9 et utilis\xe9e avec succ\xe8s dans de nombreuses applications de production. Il est facile d'int\xe9grer cette biblioth\xe8que dans une application "),e.j41(510,"strong"),e.EFF(511,"Nest"),e.k0s(),e.EFF(512," en utilisant le module "),e.j41(513,"code"),e.EFF(514,"@nestjs/passport"),e.k0s(),e.EFF(515,"."),e.k0s(),e.j41(516,"p"),e.EFF(517,"Pour savoir comment int\xe9grer Passport \xe0 NestJS, consultez ce "),e.j41(518,"a",37),e.EFF(519,"chapitre"),e.k0s(),e.EFF(520,"."),e.k0s(),e.j41(521,"h4",38)(522,"span"),e.EFF(523,"Exemple"),e.k0s()(),e.j41(524,"p"),e.EFF(525,"Vous trouverez une version compl\xe8te du code de ce chapitre "),e.j41(526,"a",39),e.EFF(527,"ici"),e.k0s(),e.EFF(528,"."),e.k0s()()),2&n){const d=e.sdS(63),u=e.sdS(89),i=e.sdS(112),a=e.sdS(144),F=e.sdS(164),j=e.sdS(227),k=e.sdS(275),h=e.sdS(306),x=e.sdS(364),C=e.sdS(383);e.R7$(60),e.SpI(" ",e.i5U(61,38,"users/users.service",d.isJsActive),"\n"),e.R7$(4),e.AVh("hide",d.isJsActive),e.R7$(3),e.AVh("hide",!d.isJsActive),e.R7$(19),e.SpI(" ",e.i5U(87,41,"users/users.module",u.isJsActive),"\n"),e.R7$(4),e.AVh("hide",u.isJsActive),e.R7$(3),e.AVh("hide",!u.isJsActive),e.R7$(16),e.SpI(" ",e.i5U(110,44,"auth/auth.service",i.isJsActive),"\n"),e.R7$(4),e.AVh("hide",i.isJsActive),e.R7$(3),e.AVh("hide",!i.isJsActive),e.R7$(25),e.SpI(" ",e.i5U(142,47,"auth/auth.module",a.isJsActive),"\n"),e.R7$(4),e.AVh("hide",a.isJsActive),e.R7$(3),e.AVh("hide",!a.isJsActive),e.R7$(13),e.SpI(" ",e.i5U(162,50,"auth/auth.controller",F.isJsActive),"\n"),e.R7$(63),e.SpI(" ",e.i5U(225,53,"auth/auth.service",j.isJsActive),"\n"),e.R7$(4),e.AVh("hide",j.isJsActive),e.R7$(3),e.AVh("hide",!j.isJsActive),e.R7$(41),e.SpI(" ",e.i5U(273,56,"auth/constants",k.isJsActive),"\n"),e.R7$(4),e.AVh("hide",k.isJsActive),e.R7$(3),e.AVh("hide",!k.isJsActive),e.R7$(24),e.SpI(" ",e.i5U(304,59,"auth/auth.module",h.isJsActive),"\n"),e.R7$(4),e.AVh("hide",h.isJsActive),e.R7$(3),e.AVh("hide",!h.isJsActive),e.R7$(51),e.SpI(" ",e.i5U(362,62,"auth/auth.guard",x.isJsActive),"\n"),e.R7$(19),e.SpI(" ",e.i5U(381,65,"auth.controller",C.isJsActive),"\n")}},dependencies:[m.O,l.a,b.q,p.z,E.Wk,f.M],encapsulation:2,changeDetection:0})}return t})(),data:{title:"Authentification"}},{path:"cors",component:(()=>{class t extends c.y{static \u0275fac=(()=>{let s;return function(o){return(s||(s=e.xGo(t)))(o||t)}})();static \u0275cmp=e.VBU({type:t,selectors:[["app-cors"]],features:[e.Vt3],decls:62,vars:0,consts:[["contentReference",""],[1,"content"],[1,"github-links"],["href","https://github.com/Lou8is/docs.nestjs.fr/edit/main/content/security/cors.md","aria-label","Proposer des modifications","title","Proposer des modifications"],[1,"fas","fa-edit"],["id","cors"],["rel","nofollow","target","_blank","href","https://github.com/expressjs/cors"],["rel","nofollow","target","_blank","href","https://github.com/fastify/fastify-cors"],["appAnchor","","id","pour-commencer"],[1,"language-typescript"],["rel","nofollow","target","_blank","href","https://github.com/expressjs/cors#configuration-options"],["rel","nofollow","target","_blank","href","https://github.com/expressjs/cors#configuring-cors-asynchronously"]],template:function(n,o){1&n&&(e.j41(0,"div",1,0)(2,"div",2)(3,"a",3),e.nrm(4,"i",4),e.k0s()(),e.j41(5,"h3",5),e.EFF(6,"CORS"),e.k0s(),e.j41(7,"p"),e.EFF(8,'Cross-origin resource sharing (CORS) (litt\xe9ralement " partage de ressources entre origines multiples ") est un m\xe9canisme qui permet de demander des ressources \xe0 un autre domaine. Sous le capot, Nest utilise les packages Express '),e.j41(9,"a",6),e.EFF(10,"cors"),e.k0s(),e.EFF(11," ou Fastify "),e.j41(12,"a",7),e.EFF(13,"@fastify/cors"),e.k0s(),e.EFF(14," en fonction de la plateforme utilis\xe9e. Ces packages fournissent diverses options que vous pouvez personnaliser en fonction de vos besoins."),e.k0s(),e.j41(15,"h4",8)(16,"span"),e.EFF(17,"Pour commencer"),e.k0s()(),e.j41(18,"p"),e.EFF(19,"Pour activer CORS, appelez la m\xe9thode "),e.j41(20,"code"),e.EFF(21,"enableCors()"),e.k0s(),e.EFF(22," sur l'objet d'application Nest."),e.k0s(),e.j41(23,"app-copy-button")(24,"pre")(25,"code",9),e.EFF(26,"\nconst app = await NestFactory.create(AppModule);\napp.enableCors();\nawait app.listen(process.env.PORT ?? 3000);\n"),e.k0s()()(),e.j41(27,"p"),e.EFF(28,"La m\xe9thode "),e.j41(29,"code"),e.EFF(30,"enableCors()"),e.k0s(),e.EFF(31," prend en argument un objet de configuration optionnel. Les propri\xe9t\xe9s disponibles de cet objet sont d\xe9crites dans la documentation officielle "),e.j41(32,"a",10),e.EFF(33,"CORS"),e.k0s(),e.EFF(34,". Une autre solution consiste \xe0 passer une "),e.j41(35,"a",11),e.EFF(36,"fonction callback"),e.k0s(),e.EFF(37," qui vous permet de d\xe9finir l'objet de configuration de mani\xe8re asynchrone en fonction de la requ\xeate (\xe0 la vol\xe9e)."),e.k0s(),e.j41(38,"p"),e.EFF(39,"Alternativement, activez CORS via l'objet options de la m\xe9thode "),e.j41(40,"code"),e.EFF(41,"create()"),e.k0s(),e.EFF(42,". Mettez la propri\xe9t\xe9 "),e.j41(43,"code"),e.EFF(44,"cors"),e.k0s(),e.EFF(45," \xe0 "),e.j41(46,"code"),e.EFF(47,"true"),e.k0s(),e.EFF(48," pour activer CORS avec les param\xe8tres par d\xe9faut.\nOu bien, passez un "),e.j41(49,"a",10),e.EFF(50,"objet de configuration CORS"),e.k0s(),e.EFF(51," ou une "),e.j41(52,"a",11),e.EFF(53,"fonction callback"),e.k0s(),e.EFF(54," comme valeur de la propri\xe9t\xe9 "),e.j41(55,"code"),e.EFF(56,"cors"),e.k0s(),e.EFF(57," pour personnaliser son comportement."),e.k0s(),e.j41(58,"app-copy-button")(59,"pre")(60,"code",9),e.EFF(61,"\nconst app = await NestFactory.create(AppModule, { cors: true });\nawait app.listen(process.env.PORT ?? 3000);\n"),e.k0s()()()())},dependencies:[l.a,p.z],encapsulation:2,changeDetection:0})}return t})(),data:{title:"CORS"}},{path:"helmet",component:(()=>{class t extends c.y{static \u0275fac=(()=>{let s;return function(o){return(s||(s=e.xGo(t)))(o||t)}})();static \u0275cmp=e.VBU({type:t,selectors:[["app-helmet"]],features:[e.Vt3],decls:112,vars:0,consts:[["contentReference",""],[1,"content"],[1,"github-links"],["href","https://github.com/Lou8is/docs.nestjs.fr/edit/main/content/security/helmet.md","aria-label","Proposer des modifications","title","Proposer des modifications"],[1,"fas","fa-edit"],["id","helmet"],["rel","nofollow","target","_blank","href","https://github.com/helmetjs/helmet"],["rel","nofollow","target","_blank","href","https://github.com/helmetjs/helmet#how-it-works"],[1,"info"],["appAnchor","","id","utilisation-avec-express-par-d\xe9faut"],[1,"language-bash"],[1,"language-typescript"],[1,"warning"],["href","/graphql/quick-start#apollo-sandbox"],["rel","nofollow","target","_blank","href","https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP"],["appAnchor","","id","utilisation-avec-fastify"],["rel","nofollow","target","_blank","href","https://github.com/fastify/fastify-helmet"],["rel","nofollow","target","_blank","href","https://www.fastify.io/docs/latest/Reference/Plugins/"]],template:function(n,o){1&n&&(e.j41(0,"div",1,0)(2,"div",2)(3,"a",3),e.nrm(4,"i",4),e.k0s()(),e.j41(5,"h3",5),e.EFF(6,"Helmet"),e.k0s(),e.j41(7,"p")(8,"a",6),e.EFF(9,"Helmet"),e.k0s(),e.EFF(10," peut vous aider \xe0 prot\xe9ger votre application contre certaines vuln\xe9rabilit\xe9s Web bien connues en d\xe9finissant les en-t\xeates HTTP de mani\xe8re appropri\xe9e. En g\xe9n\xe9ral, Helmet est juste une collection de fonctions middleware plus petites qui d\xe9finissent des en-t\xeates HTTP li\xe9s \xe0 la s\xe9curit\xe9 (en lire "),e.j41(11,"a",7),e.EFF(12,"plus"),e.k0s(),e.EFF(13,")."),e.k0s(),e.j41(14,"blockquote",8)(15,"strong"),e.EFF(16,"Astuce"),e.k0s(),e.EFF(17," Notez que l'application de "),e.j41(18,"code"),e.EFF(19,"helmet"),e.k0s(),e.EFF(20," en tant que global ou son enregistrement doit venir avant d'autres appels \xe0 "),e.j41(21,"code"),e.EFF(22,"app.use()"),e.k0s(),e.EFF(23," ou des fonctions de configuration qui peuvent appeler "),e.j41(24,"code"),e.EFF(25,"app.use()"),e.k0s(),e.EFF(26,". Ceci est d\xfb \xe0 la fa\xe7on dont la plateforme sous-jacente (c'est-\xe0-dire Express ou Fastify) fonctionne, o\xf9 l'ordre dans lequel les middlewares/routes sont d\xe9finis est important. Si vous utilisez un middleware comme "),e.j41(27,"code"),e.EFF(28,"helmet"),e.k0s(),e.EFF(29," ou "),e.j41(30,"code"),e.EFF(31,"cors"),e.k0s(),e.EFF(32," apr\xe8s avoir d\xe9fini une route, alors ce middleware ne s'appliquera pas \xe0 cette route, il ne s'appliquera qu'aux routes d\xe9finies apr\xe8s le middleware.\n"),e.k0s(),e.j41(33,"h4",9)(34,"span"),e.EFF(35,"Utilisation avec Express (par d\xe9faut)"),e.k0s()(),e.j41(36,"p"),e.EFF(37,"Commencez par installer le package requis."),e.k0s(),e.j41(38,"pre")(39,"code",10),e.EFF(40,"\n$ npm i --save helmet\n"),e.k0s()(),e.j41(41,"p"),e.EFF(42,"Une fois l'installation termin\xe9e, appliquez-le en tant que middleware global."),e.k0s(),e.j41(43,"app-copy-button")(44,"pre")(45,"code",11),e.EFF(46,"\nimport helmet from 'helmet';\n// quelque part dans votre fichier d'initialisation\napp.use(helmet());\n"),e.k0s()()(),e.j41(47,"blockquote",12)(48,"strong"),e.EFF(49,"Attention"),e.k0s(),e.EFF(50," Lorsque vous utilisez "),e.j41(51,"code"),e.EFF(52,"helmet"),e.k0s(),e.EFF(53,", "),e.j41(54,"code"),e.EFF(55,"@apollo/server"),e.k0s(),e.EFF(56," (4.x), et la "),e.j41(57,"a",13),e.EFF(58,"Sandbox Apollo"),e.k0s(),e.EFF(59,", il peut y avoir un probl\xe8me avec "),e.j41(60,"a",14),e.EFF(61,"CSP"),e.k0s(),e.EFF(62," sur la Sandbox Apollo. Pour r\xe9soudre ce probl\xe8me, configurez le CSP comme indiqu\xe9 ci-dessous :\n"),e.j41(63,"app-copy-button")(64,"pre")(65,"code",11),e.EFF(66,"\napp.use(helmet({\n  crossOriginEmbedderPolicy: false,\n  contentSecurityPolicy: {\n    directives: {\n      imgSrc: [`'self'`, 'data:', 'apollo-server-landing-page.cdn.apollographql.com'],\n      scriptSrc: [`'self'`, `https: 'unsafe-inline'`],\n      manifestSrc: [`'self'`, 'apollo-server-landing-page.cdn.apollographql.com'],\n      frameSrc: [`'self'`, 'sandbox.embed.apollographql.com'],\n    },\n  },\n}));\n"),e.k0s()()()(),e.j41(67,"h4",15)(68,"span"),e.EFF(69,"Utilisation avec Fastify"),e.k0s()(),e.j41(70,"p"),e.EFF(71,"Si vous utilisez "),e.j41(72,"code"),e.EFF(73,"FastifyAdapter"),e.k0s(),e.EFF(74,", installez le package "),e.j41(75,"a",16),e.EFF(76,"@fastify/helmet"),e.k0s(),e.EFF(77," :"),e.k0s(),e.j41(78,"pre")(79,"code",10),e.EFF(80,"\n$ npm i --save @fastify/helmet\n"),e.k0s()(),e.j41(81,"p")(82,"a",16),e.EFF(83,"fastify-helmet"),e.k0s(),e.EFF(84," ne doit pas \xeatre utilis\xe9 comme un middleware, mais comme un "),e.j41(85,"a",17),e.EFF(86,"plugin Fastify"),e.k0s(),e.EFF(87,", c'est-\xe0-dire en utilisant "),e.j41(88,"code"),e.EFF(89,"app.register()"),e.k0s(),e.EFF(90," :"),e.k0s(),e.j41(91,"app-copy-button")(92,"pre")(93,"code",11),e.EFF(94,"\nimport helmet from '@fastify/helmet'\n// quelque part dans votre fichier d'initialisation\nawait app.register(helmet)\n"),e.k0s()()(),e.j41(95,"blockquote",12)(96,"strong"),e.EFF(97,"Attention"),e.k0s(),e.EFF(98," Lors de l'utilisation de "),e.j41(99,"code"),e.EFF(100,"apollo-server-fastify"),e.k0s(),e.EFF(101," et "),e.j41(102,"code"),e.EFF(103,"@fastify/helmet"),e.k0s(),e.EFF(104,", il peut y avoir un probl\xe8me avec "),e.j41(105,"a",14),e.EFF(106,"CSP"),e.k0s(),e.EFF(107," sur le terrain de jeu GraphQL, pour r\xe9soudre cette collision, configurez le CSP comme indiqu\xe9 ci-dessous :\n"),e.j41(108,"app-copy-button")(109,"pre")(110,"code",11),e.EFF(111,"\nawait app.register(fastifyHelmet, {\n   contentSecurityPolicy: {\n     directives: {\n       defaultSrc: [`'self'`, 'unpkg.com'],\n       styleSrc: [\n         `'self'`,\n         `'unsafe-inline'`,\n         'cdn.jsdelivr.net',\n         'fonts.googleapis.com',\n         'unpkg.com',\n       ],\n       fontSrc: [`'self'`, 'fonts.gstatic.com', 'data:'],\n       imgSrc: [`'self'`, 'data:', 'cdn.jsdelivr.net'],\n       scriptSrc: [\n         `'self'`,\n         `https: 'unsafe-inline'`,\n         `cdn.jsdelivr.net`,\n         `'unsafe-eval'`,\n       ],\n     },\n   },\n });\n\n// Si vous n'avez pas l'intention d'utiliser CSP, vous pouvez utiliser ceci :\nawait app.register(fastifyHelmet, {\n  contentSecurityPolicy: false,\n});\n"),e.k0s()()()()())},dependencies:[l.a,p.z],encapsulation:2,changeDetection:0})}return t})(),data:{title:"Helmet"}},{path:"encryption-and-hashing",component:(()=>{class t extends c.y{static \u0275fac=(()=>{let s;return function(o){return(s||(s=e.xGo(t)))(o||t)}})();static \u0275cmp=e.VBU({type:t,selectors:[["app-encryption-hashing"]],features:[e.Vt3],decls:98,vars:0,consts:[["contentReference",""],[1,"content"],[1,"github-links"],["href","https://github.com/Lou8is/docs.nestjs.fr/edit/main/content/security/encryption-hashing.md","aria-label","Proposer des modifications","title","Proposer des modifications"],[1,"fas","fa-edit"],["id","chiffrement-et-hachage"],["appAnchor","","id","chiffrement"],["rel","nofollow","target","_blank","href","https://nodejs.org/api/crypto.html"],[1,"language-typescript"],[1,"warning"],["appAnchor","","id","hachage"],["rel","nofollow","target","_blank","href","https://www.npmjs.com/package/bcrypt"],["rel","nofollow","target","_blank","href","https://www.npmjs.com/package/argon2"],[1,"language-shell"]],template:function(n,o){1&n&&(e.j41(0,"div",1,0)(2,"div",2)(3,"a",3),e.nrm(4,"i",4),e.k0s()(),e.j41(5,"h3",5),e.EFF(6,"Chiffrement et hachage"),e.k0s(),e.j41(7,"p")(8,"strong"),e.EFF(9,"Le chiffrement"),e.k0s(),e.EFF(10," est le processus d'encodage des informations. Ce processus convertit la repr\xe9sentation originale de l'information, connue sous le nom de texte en clair, en une forme alternative connue sous le nom de texte chiffr\xe9. Id\xe9alement, seules les parties autoris\xe9es peuvent d\xe9chiffrer un texte chiffr\xe9 en texte clair et acc\xe9der \xe0 l'information d'origine. Le chiffrement n'emp\xeache pas en soi les interf\xe9rences, mais refuse le contenu intelligible \xe0 un intercepteur potentiel. Le chiffrement est une fonction bidirectionnelle ; ce qui est chiffr\xe9 peut \xeatre d\xe9chiffr\xe9 avec la cl\xe9 appropri\xe9e."),e.k0s(),e.j41(11,"p")(12,"strong"),e.EFF(13,"Le hachage"),e.k0s(),e.EFF(14," est le processus de conversion d'une cl\xe9 donn\xe9e en une autre valeur. Une fonction de hachage est utilis\xe9e pour g\xe9n\xe9rer la nouvelle valeur selon un algorithme math\xe9matique. Une fois le hachage effectu\xe9, il devrait \xeatre impossible de passer de la sortie \xe0 l'entr\xe9e."),e.k0s(),e.j41(15,"h4",6)(16,"span"),e.EFF(17,"Chiffrement"),e.k0s()(),e.j41(18,"p"),e.EFF(19,"Node.js fournit un "),e.j41(20,"a",7),e.EFF(21,"module cryptographique"),e.k0s(),e.EFF(22," int\xe9gr\xe9 que vous pouvez utiliser pour chiffrer et d\xe9chiffrer des cha\xeenes, des nombres, des buffers, des flux, etc. Nest lui-m\xeame ne fournit aucun package suppl\xe9mentaire au-dessus de ce module afin d'\xe9viter d'introduire des abstractions inutiles."),e.k0s(),e.j41(23,"p"),e.EFF(24,"A titre d'exemple, utilisons l'algorithme AES (Advanced Encryption System) "),e.j41(25,"code"),e.EFF(26,"'aes-256-ctr'"),e.k0s(),e.EFF(27," en mode de cryptage CTR."),e.k0s(),e.j41(28,"app-copy-button")(29,"pre")(30,"code",8),e.EFF(31,"\nimport { createCipheriv, randomBytes, scrypt } from 'crypto';\nimport { promisify } from 'util';\n\nconst iv = randomBytes(16);\nconst password = 'Password used to generate key';\n\n// La longueur de la cl\xe9 d\xe9pend de l'algorithme.\n// Dans ce cas, pour aes256, il s'agit de 32 octets.\nconst key = (await promisify(scrypt)(password, 'salt', 32)) as Buffer;\nconst cipher = createCipheriv('aes-256-ctr', key, iv);\n\nconst textToEncrypt = 'Nest';\nconst encryptedText = Buffer.concat([\n  cipher.update(textToEncrypt),\n  cipher.final(),\n]);\n"),e.k0s()()(),e.j41(32,"blockquote",9)(33,"strong"),e.EFF(34,"Attention"),e.k0s(),e.EFF(35," Un m\xeame vecteur d'initialisation (IV) ne doit pas \xeatre r\xe9utilis\xe9 pour chiffrer plusieurs messages avec une m\xeame cl\xe9\n"),e.k0s(),e.j41(36,"p"),e.EFF(37,"Il faut maintenant d\xe9crypter la valeur "),e.j41(38,"code"),e.EFF(39,"encryptedText"),e.k0s(),e.EFF(40," :"),e.k0s(),e.j41(41,"app-copy-button")(42,"pre")(43,"code",8),e.EFF(44,"\nimport { createDecipheriv } from 'crypto';\n\nconst decipher = createDecipheriv('aes-256-ctr', key, iv);\nconst decryptedText = Buffer.concat([\n  decipher.update(encryptedText),\n  decipher.final(),\n]);\n"),e.k0s()()(),e.j41(45,"h4",10)(46,"span"),e.EFF(47,"Hachage"),e.k0s()(),e.j41(48,"p"),e.EFF(49,"Pour le hachage, nous recommandons d'utiliser les packages "),e.j41(50,"a",11),e.EFF(51,"bcrypt"),e.k0s(),e.EFF(52," ou "),e.j41(53,"a",12),e.EFF(54,"argon2"),e.k0s(),e.EFF(55,". Nest lui-m\xeame ne fournit pas d'enveloppe suppl\xe9mentaire au-dessus de ces modules afin d'\xe9viter d'introduire des abstractions inutiles (ce qui rend la courbe d'apprentissage courte)."),e.k0s(),e.j41(56,"p"),e.EFF(57,"Par exemple, utilisons "),e.j41(58,"code"),e.EFF(59,"bcrypt"),e.k0s(),e.EFF(60," pour hacher un mot de passe al\xe9atoire."),e.k0s(),e.j41(61,"p"),e.EFF(62,"Installez d'abord les packages n\xe9cessaires :"),e.k0s(),e.j41(63,"pre")(64,"code",13),e.EFF(65,"\n$ npm i bcrypt\n$ npm i -D @types/bcrypt\n"),e.k0s()(),e.j41(66,"p"),e.EFF(67,"Une fois l'installation termin\xe9e, vous pouvez utiliser la fonction "),e.j41(68,"code"),e.EFF(69,"hash"),e.k0s(),e.EFF(70,", comme suit :"),e.k0s(),e.j41(71,"app-copy-button")(72,"pre")(73,"code",8),e.EFF(74,"\nimport * as bcrypt from 'bcrypt';\n\nconst saltOrRounds = 10;\nconst password = 'random_password';\nconst hash = await bcrypt.hash(password, saltOrRounds);\n"),e.k0s()()(),e.j41(75,"p"),e.EFF(76,"Pour g\xe9n\xe9rer un salt, utilisez la fonction "),e.j41(77,"code"),e.EFF(78,"genSalt"),e.k0s(),e.EFF(79," :"),e.k0s(),e.j41(80,"app-copy-button")(81,"pre")(82,"code",8),e.EFF(83,"\nconst salt = await bcrypt.genSalt();\n"),e.k0s()()(),e.j41(84,"p"),e.EFF(85,"Pour comparer/v\xe9rifier un mot de passe, utilisez la fonction "),e.j41(86,"code"),e.EFF(87,"compare"),e.k0s(),e.EFF(88," :"),e.k0s(),e.j41(89,"app-copy-button")(90,"pre")(91,"code",8),e.EFF(92,"\nconst isMatch = await bcrypt.compare(password, hash);\n"),e.k0s()()(),e.j41(93,"p"),e.EFF(94,"Vous pouvez en savoir plus sur les fonctions disponibles "),e.j41(95,"a",11),e.EFF(96,"ici"),e.k0s(),e.EFF(97,"."),e.k0s()())},dependencies:[l.a,p.z],encapsulation:2,changeDetection:0})}return t})(),data:{title:"Chiffrement et hachage"}},{path:"csrf",component:(()=>{class t extends c.y{static \u0275fac=(()=>{let s;return function(o){return(s||(s=e.xGo(t)))(o||t)}})();static \u0275cmp=e.VBU({type:t,selectors:[["app-csrf"]],features:[e.Vt3],decls:68,vars:0,consts:[["contentReference",""],[1,"content"],[1,"github-links"],["href","https://github.com/Lou8is/docs.nestjs.fr/edit/main/content/security/csrf.md","aria-label","Proposer des modifications","title","Proposer des modifications"],[1,"fas","fa-edit"],["id","protection-csrf"],["rel","nofollow","target","_blank","href","https://github.com/Psifi-Solutions/csrf-csrf"],["appAnchor","","id","utilisation-avec-express-par-d\xe9faut"],[1,"language-bash"],[1,"warning"],["rel","nofollow","target","_blank","href","https://github.com/Psifi-Solutions/csrf-csrf?tab=readme-ov-file#getting-started"],[1,"language-typescript"],["appAnchor","","id","utilisation-avec-fastify"],["rel","nofollow","target","_blank","href","https://github.com/fastify/csrf-protection#usage"]],template:function(n,o){1&n&&(e.j41(0,"div",1,0)(2,"div",2)(3,"a",3),e.nrm(4,"i",4),e.k0s()(),e.j41(5,"h3",5),e.EFF(6,"Protection CSRF"),e.k0s(),e.j41(7,"p"),e.EFF(8,"Le Cross-site request forgery (CSRF ou XSRF) est un type d'attaque par lequel des commandes "),e.j41(9,"strong"),e.EFF(10,"non autoris\xe9es"),e.k0s(),e.EFF(11," sont envoy\xe9es d'un utilisateur de confiance \xe0 une application web. Pour \xe9viter cela, vous pouvez utiliser le paquet "),e.j41(12,"a",6),e.EFF(13,"csrf-csrf"),e.k0s(),e.EFF(14,"."),e.k0s(),e.j41(15,"h4",7)(16,"span"),e.EFF(17,"Utilisation avec Express (par d\xe9faut)"),e.k0s()(),e.j41(18,"p"),e.EFF(19,"Commencez par installer le package requis :"),e.k0s(),e.j41(20,"pre")(21,"code",8),e.EFF(22,"\n$ npm i csrf-csrf\n"),e.k0s()(),e.j41(23,"blockquote",9)(24,"strong"),e.EFF(25,"Attention"),e.k0s(),e.EFF(26," Comme indiqu\xe9 dans la [documentation csrf-csrf] ("),e.j41(27,"a",10),e.EFF(28,"https://github.com/Psifi-Solutions/csrf-csrf?tab=readme-ov-file#getting-started"),e.k0s(),e.EFF(29,"), ce middleware n\xe9cessite que le middleware de session ou "),e.j41(30,"code"),e.EFF(31,"cookie-parser"),e.k0s(),e.EFF(32," soit initialis\xe9 au pr\xe9alable. Veuillez vous r\xe9f\xe9rer \xe0 la documentation pour plus de d\xe9tails.\n"),e.k0s(),e.j41(33,"p"),e.EFF(34,"Une fois l'installation termin\xe9e, appliquez le middleware "),e.j41(35,"code"),e.EFF(36,"csrf-csrf"),e.k0s(),e.EFF(37," en tant que middleware global."),e.k0s(),e.j41(38,"app-copy-button")(39,"pre")(40,"code",11),e.EFF(41,"\nimport { doubleCsrf } from 'csrf-csrf';\n// ...\n// quelque part dans votre fichier d'initialisation\nconst {\n  invalidCsrfTokenError, // This is provided purely for convenience if you plan on creating your own middleware.\n  generateToken, // Use this in your routes to generate and provide a CSRF hash, along with a token cookie and token.\n  validateRequest, // Also a convenience if you plan on making your own middleware.\n  doubleCsrfProtection, // This is the default CSRF protection middleware.\n} = doubleCsrf(doubleCsrfOptions);\napp.use(doubleCsrfProtection);\n"),e.k0s()()(),e.j41(42,"h4",12)(43,"span"),e.EFF(44,"Utilisation avec Fastify"),e.k0s()(),e.j41(45,"p"),e.EFF(46,"Commencez par installer le package requis :"),e.k0s(),e.j41(47,"pre")(48,"code",8),e.EFF(49,"\n$ npm i --save @fastify/csrf-protection\n"),e.k0s()(),e.j41(50,"p"),e.EFF(51,"Une fois l'installation termin\xe9e, enregistrez le plugin "),e.j41(52,"code"),e.EFF(53,"@fastify/csrf-protection"),e.k0s(),e.EFF(54,", comme suit :"),e.k0s(),e.j41(55,"app-copy-button")(56,"pre")(57,"code",11),e.EFF(58,"\nimport fastifyCsrf from '@fastify/csrf-protection';\n// ...\n// quelque part dans votre fichier d'initialisation apr\xe8s l'enregistrement d'un plugin de stockage\nawait app.register(fastifyCsrf);\n"),e.k0s()()(),e.j41(59,"blockquote",9)(60,"strong"),e.EFF(61,"Attention"),e.k0s(),e.EFF(62," Comme expliqu\xe9 dans la documentation "),e.j41(63,"code"),e.EFF(64,"@fastify/csrf-protection"),e.k0s(),e.j41(65,"a",13),e.EFF(66,"ici"),e.k0s(),e.EFF(67,", ce plugin n\xe9cessite l'initialisation pr\xe9alable d'un plugin de stockage. Veuillez consulter cette documentation pour plus d'instructions.\n"),e.k0s()())},dependencies:[l.a,p.z],encapsulation:2,changeDetection:0})}return t})(),data:{title:"CSRF"}},{path:"rate-limiting",component:(()=>{class t extends c.y{static \u0275fac=(()=>{let s;return function(o){return(s||(s=e.xGo(t)))(o||t)}})();static \u0275cmp=e.VBU({type:t,selectors:[["app-rate-limiting"]],features:[e.Vt3],decls:550,vars:22,consts:[["contentReference",""],["app116a8432faea0c9a2a3d174e202725b6c5ee8401",""],["app03221b2945d55e9f2c286e93295453afb5b06e78",""],["appe80b506057af72e8120d1c8a4e4fc7ad03c144b4",""],["app8a879ecd744796203673efdd439d1cdb3cdf7bb7",""],[1,"content"],[1,"github-links"],["href","https://github.com/Lou8is/docs.nestjs.fr/edit/main/content/security/rate-limiting.md","aria-label","Proposer des modifications","title","Proposer des modifications"],[1,"fas","fa-edit"],["id","limitation-du-d\xe9bit"],[1,"language-bash"],[1,"with-heading"],[1,"filename"],[1,"language-typescript"],["routerLink","/guards"],["appAnchor","","id","d\xe9finitions-de-plusieurs-limitateurs"],["appAnchor","","id","personnalisation"],["appAnchor","","id","proxys"],["rel","nofollow","target","_blank","href","http://expressjs.com/en/guide/behind-proxies.html"],["rel","nofollow","target","_blank","href","https://www.fastify.io/docs/latest/Reference/Server/#trustproxy"],[1,"info"],["rel","nofollow","target","_blank","href","https://expressjs.com/en/api.html#req.ips"],["rel","nofollow","target","_blank","href","https://www.fastify.io/docs/latest/Reference/Request/"],["appAnchor","","id","websockets"],["appAnchor","","id","graphql"],["appAnchor","","id","configuration"],["href","/security/rate-limiting#storages"],["appAnchor","","id","configuration-asynchrone"],["appAnchor","","id","stockages"],["rel","nofollow","target","_blank","href","https://github.com/jmcdo29/nest-lab/tree/main/packages/throttler-storage-redis"],["appAnchor","","id","helpers-de-temps"],["appAnchor","","id","guide-de-migration"],[1,"Warning"],["rel","nofollow","target","_blank","href","https://github.com/nestjs/throttler/blob/master/CHANGELOG.md#500"]],template:function(n,o){if(1&n&&(e.j41(0,"div",5,0)(2,"div",6)(3,"a",7),e.nrm(4,"i",8),e.k0s()(),e.j41(5,"h3",9),e.EFF(6,"Limitation du d\xe9bit"),e.k0s(),e.j41(7,"p"),e.EFF(8,"Une technique courante pour prot\xe9ger les applications des attaques par force brute est la "),e.j41(9,"strong"),e.EFF(10,"limitation de d\xe9bit"),e.k0s(),e.EFF(11,". Pour commencer, vous devez installer le package "),e.j41(12,"code"),e.EFF(13,"@nestjs/throttler"),e.k0s(),e.EFF(14,"."),e.k0s(),e.j41(15,"pre")(16,"code",10),e.EFF(17,"\n$ npm i --save @nestjs/throttler\n"),e.k0s()(),e.j41(18,"p"),e.EFF(19,"Une fois l'installation termin\xe9e, le "),e.j41(20,"code"),e.EFF(21,"ThrottlerModule"),e.k0s(),e.EFF(22," peut \xeatre configur\xe9 comme n'importe quel autre package Nest avec les m\xe9thodes "),e.j41(23,"code"),e.EFF(24,"forRoot"),e.k0s(),e.EFF(25," ou "),e.j41(26,"code"),e.EFF(27,"forRootAsync"),e.k0s(),e.EFF(28,"."),e.k0s(),e.j41(29,"app-copy-button",11)(30,"span",12),e.EFF(31),e.nI1(32,"extension"),e.nrm(33,"app-tabs",null,1),e.k0s(),e.j41(35,"pre")(36,"code",13),e.EFF(37,"\n@Module({\n  imports: [\n    ThrottlerModule.forRoot([{\n      ttl: 60000,\n      limit: 10,\n    }]),\n  ],\n})\nexport class AppModule {}\n"),e.k0s()()(),e.j41(38,"p"),e.EFF(39,"Ce qui pr\xe9c\xe8de d\xe9finira les options globales pour le "),e.j41(40,"code"),e.EFF(41,"ttl"),e.k0s(),e.EFF(42,", le temps de vie en millisecondes, et le "),e.j41(43,"code"),e.EFF(44,"limit"),e.k0s(),e.EFF(45,", le nombre maximum de requ\xeates dans le ttl, pour les routes de votre application qui sont surveill\xe9es."),e.k0s(),e.j41(46,"p"),e.EFF(47,"Une fois que le module a \xe9t\xe9 import\xe9, vous pouvez choisir comment vous souhaitez lier le "),e.j41(48,"code"),e.EFF(49,"ThrottlerGuard"),e.k0s(),e.EFF(50,". N'importe quel type de liaison tel que mentionn\xe9 dans la section sur les "),e.j41(51,"a",14),e.EFF(52,"gardes"),e.k0s(),e.EFF(53," est acceptable. Si vous voulez lier la garde globalement, par exemple, vous pouvez le faire en ajoutant ce fournisseur \xe0 n'importe quel module :"),e.k0s(),e.j41(54,"app-copy-button")(55,"pre")(56,"code",13),e.EFF(57,"\n{\n  provide: APP_GUARD,\n  useClass: ThrottlerGuard\n}\n"),e.k0s()()(),e.j41(58,"h4",15)(59,"span"),e.EFF(60,"D\xe9finitions de plusieurs limitateurs"),e.k0s()(),e.j41(61,"p"),e.EFF(62,"Il peut arriver que vous souhaitiez mettre en place plusieurs d\xe9finitions de limitation, comme par exemple pas plus de 3 appels par seconde, 20 appels en 10 secondes, et 100 appels en une minute. Pour ce faire, vous pouvez mettre en place vos d\xe9finitions dans le tableau avec des options nomm\xe9es, qui peuvent ensuite \xeatre r\xe9f\xe9renc\xe9es dans les d\xe9corateurs "),e.j41(63,"code"),e.EFF(64,"@SkipThrottle()"),e.k0s(),e.EFF(65," et "),e.j41(66,"code"),e.EFF(67,"@Throttle()"),e.k0s(),e.EFF(68," pour changer les options \xe0 nouveau."),e.k0s(),e.j41(69,"app-copy-button",11)(70,"span",12),e.EFF(71),e.nI1(72,"extension"),e.nrm(73,"app-tabs",null,2),e.k0s(),e.j41(75,"pre")(76,"code",13),e.EFF(77,"\n@Module({\n  imports: [\n    ThrottlerModule.forRoot([\n      {\n        name: 'short',\n        ttl: 1000,\n        limit: 3,\n      },\n      {\n        name: 'medium',\n        ttl: 10000,\n        limit: 20\n      },\n      {\n        name: 'long',\n        ttl: 60000,\n        limit: 100\n      }\n    ]),\n  ],\n})\nexport class AppModule {}\n"),e.k0s()()(),e.j41(78,"h4",16)(79,"span"),e.EFF(80,"Personnalisation"),e.k0s()(),e.j41(81,"p"),e.EFF(82,"Il peut arriver que vous vouliez lier la garde \xe0 un contr\xf4leur ou globalement, mais que vous vouliez d\xe9sactiver la limitation de taux pour un ou plusieurs de vos terminaux. Pour cela, vous pouvez utiliser le d\xe9corateur "),e.j41(83,"code"),e.EFF(84,"@SkipThrottle()"),e.k0s(),e.EFF(85,", pour annuler le limiteur pour une classe enti\xe8re ou une seule route. Le d\xe9corateur "),e.j41(86,"code"),e.EFF(87,"@SkipThrottle()"),e.k0s(),e.EFF(88," peut aussi prendre un objet dont les cl\xe9s sont des cha\xeenes de caract\xe8res et les valeurs des bool\xe9ens pour le cas o\xf9 vous voudriez exclure "),e.j41(89,"em"),e.EFF(90,"la plus grande partie"),e.k0s(),e.EFF(91," d'un contr\xf4leur, mais pas toutes les routes, et de le configurer pour chaque ensemble de limitateurs si vous en avez plusieurs. Si vous ne passez pas d'objet, le d\xe9faut est d'utiliser "),e.j41(92,"code"),e.EFF(93),e.k0s()(),e.j41(94,"app-copy-button")(95,"pre")(96,"code",13),e.EFF(97,"\n@SkipThrottle()\n@Controller('users')\nexport class UsersController {}\n"),e.k0s()()(),e.j41(98,"p"),e.EFF(99,"Ce d\xe9corateur "),e.j41(100,"code"),e.EFF(101,"@SkipThrottle()"),e.k0s(),e.EFF(102," peut \xeatre utilis\xe9 pour ignorer une route ou une classe ou pour annuler le fait d'ignorer une route dans une classe qui est ignor\xe9e."),e.k0s(),e.j41(103,"app-copy-button")(104,"pre")(105,"code",13),e.EFF(106,"\n@SkipThrottle()\n@Controller('users')\nexport class UsersController {\n  // La limitation de d\xe9bit est appliqu\xe9e \xe0 cette route.\n  @SkipThrottle({ default: false })\n  dontSkip() {\n    return 'La liste des utilisateurs fonctionne avec la limitation.';\n  }\n  // Cette route ne tient pas compte de la limitation du d\xe9bit.\n  doSkip() {\n    return 'La liste des utilisateurs fonctionne sans la limitation.';\n  }\n}\n"),e.k0s()()(),e.j41(107,"p"),e.EFF(108,"Il y a aussi le d\xe9corateur "),e.j41(109,"code"),e.EFF(110,"@Throttle()"),e.k0s(),e.EFF(111," qui peut \xeatre utilis\xe9 pour surcharger les param\xe8tres "),e.j41(112,"code"),e.EFF(113,"limit"),e.k0s(),e.EFF(114," et "),e.j41(115,"code"),e.EFF(116,"ttl"),e.k0s(),e.EFF(117," d\xe9finis dans le module global, pour donner des options de s\xe9curit\xe9 plus ou moins strictes. Ce d\xe9corateur peut \xeatre utilis\xe9 sur une classe ou une fonction. A partir de la version 5, le d\xe9corateur prend un objet avec la cha\xeene relative au nom du limitateur, et un objet avec les cl\xe9s limit et ttl et des valeurs enti\xe8res, similaires aux options pass\xe9es au module racine. Si vous n'avez pas de nom d\xe9fini dans vos options originales, utilisez la cha\xeene "),e.j41(118,"code"),e.EFF(119,"default"),e.k0s(),e.EFF(120," Vous devez le configurer comme ceci :"),e.k0s(),e.j41(121,"app-copy-button")(122,"pre")(123,"code",13),e.EFF(124,'\n// Remplace la configuration par d\xe9faut pour la limitation du d\xe9bit et la dur\xe9e.\n@Throttle({ default: { limit: 3, ttl: 60000 } })\n@Get()\nfindAll() {\n  return "La liste des utilisateurs fonctionne avec la limitation personnalis\xe9e.";\n}\n'),e.k0s()()(),e.j41(125,"h4",17)(126,"span"),e.EFF(127,"Proxys"),e.k0s()(),e.j41(128,"p"),e.EFF(129,"Si votre application tourne derri\xe8re un serveur proxy, il est essentiel de configurer l'adaptateur HTTP pour qu'il fasse confiance au proxy. Vous pouvez vous r\xe9f\xe9rer aux options sp\xe9cifiques de l'adaptateur HTTP pour "),e.j41(130,"a",18),e.EFF(131,"Express"),e.k0s(),e.EFF(132," et "),e.j41(133,"a",19),e.EFF(134,"Fastify"),e.k0s(),e.EFF(135," pour activer le param\xe8tre "),e.j41(136,"code"),e.EFF(137,"trust proxy"),e.k0s(),e.EFF(138,"."),e.k0s(),e.j41(139,"p"),e.EFF(140,"Voici un exemple qui montre comment activer le param\xe8tre "),e.j41(141,"code"),e.EFF(142,"trust proxy"),e.k0s(),e.EFF(143," pour l'adaptateur Express :"),e.k0s(),e.j41(144,"app-copy-button",11)(145,"span",12),e.EFF(146),e.nI1(147,"extension"),e.nrm(148,"app-tabs",null,3),e.k0s(),e.j41(150,"pre")(151,"code",13),e.EFF(152,"\nimport { NestFactory } from '@nestjs/core';\nimport { AppModule } from './app.module';\nimport { NestExpressApplication } from '@nestjs/platform-express';\n\nasync function bootstrap() {\n  const app = await NestFactory.create<NestExpressApplication>(AppModule);\n  app.set('trust proxy', 'loopback'); // Demandes de confiance provenant de l'adresse de loopback\n  await app.listen(3000);\n}\n\nbootstrap();\n"),e.k0s()(),e.j41(153,"pre")(154,"code",13),e.EFF(155,"\nimport { NestFactory } from '@nestjs/core';\nimport { AppModule } from './app.module';\nimport { NestExpressApplication } from '@nestjs/platform-express';\n\nasync function bootstrap() {\n  const app = await NestFactory.create(AppModule);\n  app.set('trust proxy', 'loopback'); // Demandes de confiance provenant de l'adresse de loopback\n  await app.listen(3000);\n}\n\nbootstrap();\n"),e.k0s()()(),e.j41(156,"p"),e.EFF(157,"Activer "),e.j41(158,"code"),e.EFF(159,"trust proxy"),e.k0s(),e.EFF(160," vous permet de r\xe9cup\xe9rer l'adresse IP originale \xe0 partir de l'en-t\xeate "),e.j41(161,"code"),e.EFF(162,"X-Forwarded-For"),e.k0s(),e.EFF(163,". Vous pouvez aussi personnaliser le comportement de votre application en surchargeant la m\xe9thode "),e.j41(164,"code"),e.EFF(165,"getTracker()"),e.k0s(),e.EFF(166," pour extraire l'adresse IP de cet en-t\xeate au lieu de vous baser sur "),e.j41(167,"code"),e.EFF(168,"req.ip"),e.k0s(),e.EFF(169,". L'exemple suivant montre comment r\xe9aliser cela pour Express et Fastify :"),e.k0s(),e.j41(170,"app-copy-button",11)(171,"span",12),e.EFF(172),e.nI1(173,"extension"),e.nrm(174,"app-tabs",null,4),e.k0s(),e.j41(176,"pre")(177,"code",13),e.EFF(178,"\nimport { ThrottlerGuard } from '@nestjs/throttler';\nimport { Injectable } from '@nestjs/common';\n\n@Injectable()\nexport class ThrottlerBehindProxyGuard extends ThrottlerGuard {\n  protected async getTracker(req: Record<string, any>): Promise<string> {\n    return req.ips.length ? req.ips[0] : req.ip; // individualisez l'extraction de l'IP pour r\xe9pondre \xe0 vos propres besoins\n  }\n}\n\n// app.controller.ts\nimport { ThrottlerBehindProxyGuard } from './throttler-behind-proxy.guard';\n\n@UseGuards(ThrottlerBehindProxyGuard)\n"),e.k0s()()(),e.j41(179,"blockquote",20)(180,"strong"),e.EFF(181,"Astuce"),e.k0s(),e.EFF(182," Vous pouvez trouver l'API de l'objet de requ\xeate "),e.j41(183,"code"),e.EFF(184,"req"),e.k0s(),e.EFF(185," pour express "),e.j41(186,"a",21),e.EFF(187,"ici"),e.k0s(),e.EFF(188," et pour fastify "),e.j41(189,"a",22),e.EFF(190,"ici"),e.k0s(),e.EFF(191,".\n"),e.k0s(),e.j41(192,"h4",23)(193,"span"),e.EFF(194,"Websockets"),e.k0s()(),e.j41(195,"p"),e.EFF(196,"Ce module peut fonctionner avec des websockets, mais il n\xe9cessite une extension de classe. Vous pouvez \xe9tendre la classe "),e.j41(197,"code"),e.EFF(198,"ThrottlerGuard"),e.k0s(),e.EFF(199," et surcharger la m\xe9thode "),e.j41(200,"code"),e.EFF(201,"handleRequest"),e.k0s(),e.EFF(202," comme suit :"),e.k0s(),e.j41(203,"app-copy-button")(204,"pre")(205,"code",13),e.EFF(206,"\n@Injectable()\nexport class WsThrottlerGuard extends ThrottlerGuard {\n  async handleRequest(requestProps: ThrottlerRequest): Promise<boolean> {\n    const {\n        context,\n        limit,\n        ttl,\n        throttler,\n        blockDuration,\n        getTracker,\n        generateKey,\n    } = requestProps;\n\n    const client = context.switchToWs().getClient();\n    const tracker = client._socket.remoteAddress;\n    const key = generateKey(context, tracker, throttler.name);\n    const { totalHits, timeToExpire, isBlocked, timeToBlockExpire } =\n      await this.storageService.increment(\n        key,\n        ttl,\n        limit,\n        blockDuration,\n        throttler.name,\n      );\n\n    const getThrottlerSuffix = (name: string) =>\n      name === 'default' ? '' : `-${name}`;\n\n    // Lancer une erreur lorsque l'utilisateur a atteint sa limite.\n    if (isBlocked) {\n      await this.throwThrottlingException(context, {\n        limit,\n        ttl,\n        key,\n        tracker,\n        totalHits,\n        timeToExpire,\n        isBlocked,\n        timeToBlockExpire,\n      });\n    }\n\n    return true;\n  }\n}\n"),e.k0s()()(),e.j41(207,"blockquote",20)(208,"strong"),e.EFF(209,"Astuce"),e.k0s(),e.EFF(210," Si vous utilisez ws, il est n\xe9cessaire de remplacer "),e.j41(211,"code"),e.EFF(212,"_socket"),e.k0s(),e.EFF(213," par "),e.j41(214,"code"),e.EFF(215,"conn"),e.k0s()(),e.j41(216,"p"),e.EFF(217,"Il y a quelques points \xe0 garder \xe0 l'esprit lorsque l'on travaille avec les WebSockets :"),e.k0s(),e.j41(218,"ul")(219,"li"),e.EFF(220,"La garde ne peut pas \xeatre enregistr\xe9e avec la m\xe9thode "),e.j41(221,"code"),e.EFF(222,"APP_GUARD"),e.k0s(),e.EFF(223," ou "),e.j41(224,"code"),e.EFF(225,"app.useGlobalGuards()"),e.k0s()(),e.j41(226,"li"),e.EFF(227,"Lorsqu'une limite est atteinte, Nest \xe9mettra un \xe9v\xe9nement "),e.j41(228,"code"),e.EFF(229,"exception"),e.k0s(),e.EFF(230,", il faut donc s'assurer qu'il y a un listener pr\xeat pour cela"),e.k0s()(),e.j41(231,"blockquote",20)(232,"strong"),e.EFF(233,"Astuce"),e.k0s(),e.EFF(234," Si vous utilisez le package "),e.j41(235,"code"),e.EFF(236,"@nestjs/platform-ws"),e.k0s(),e.EFF(237,", vous pouvez utiliser "),e.j41(238,"code"),e.EFF(239,"client._socket.remoteAddress"),e.k0s(),e.EFF(240," \xe0 la place.\n"),e.k0s(),e.j41(241,"h4",24)(242,"span"),e.EFF(243,"GraphQL"),e.k0s()(),e.j41(244,"p"),e.EFF(245,"La "),e.j41(246,"code"),e.EFF(247,"ThrottlerGuard"),e.k0s(),e.EFF(248," peut \xe9galement \xeatre utilis\xe9e pour travailler avec les requ\xeates GraphQL. Encore une fois, la garde peut \xeatre \xe9tendue, mais cette fois la m\xe9thode "),e.j41(249,"code"),e.EFF(250,"getRequestResponse"),e.k0s(),e.EFF(251," sera surcharg\xe9e"),e.k0s(),e.j41(252,"app-copy-button")(253,"pre")(254,"code",13),e.EFF(255,"\n@Injectable()\nexport class GqlThrottlerGuard extends ThrottlerGuard {\n  getRequestResponse(context: ExecutionContext) {\n    const gqlCtx = GqlExecutionContext.create(context);\n    const ctx = gqlCtx.getContext();\n    return { req: ctx.req, res: ctx.res };\n  }\n}\n"),e.k0s()()(),e.j41(256,"h4",25)(257,"span"),e.EFF(258,"Configuration"),e.k0s()(),e.j41(259,"p"),e.EFF(260,"Les options suivantes sont valables pour l'objet pass\xe9 au tableau des options du "),e.j41(261,"code"),e.EFF(262,"ThrottlerModule"),e.k0s(),e.EFF(263," :"),e.k0s(),e.j41(264,"table")(265,"tr")(266,"td")(267,"code"),e.EFF(268,"name"),e.k0s()(),e.j41(269,"td"),e.EFF(270,"le nom pour le suivi interne de l'ensemble des limitateurs utilis\xe9s. La valeur par d\xe9faut est `default` si elle n'est pas fournie."),e.k0s()(),e.j41(271,"tr")(272,"td")(273,"code"),e.EFF(274,"ttl"),e.k0s()(),e.j41(275,"td"),e.EFF(276,"le nombre de secondes pendant lesquelles chaque requ\xeate restera en m\xe9moire"),e.k0s()(),e.j41(277,"tr")(278,"td")(279,"code"),e.EFF(280,"limit"),e.k0s()(),e.j41(281,"td"),e.EFF(282,"le nombre maximum de requ\xeates dans la limite du TTL"),e.k0s()(),e.j41(283,"tr")(284,"td")(285,"code"),e.EFF(286,"blockDuration"),e.k0s()(),e.j41(287,"td"),e.EFF(288,"le nombre de millisecondes pendant lesquelles la demande sera bloqu\xe9e."),e.k0s()(),e.j41(289,"tr")(290,"td")(291,"code"),e.EFF(292,"ignoreUserAgents"),e.k0s()(),e.j41(293,"td"),e.EFF(294,"une liste d'expressions r\xe9guli\xe8res d'agents-utilisateurs \xe0 ignorer pour les limitations de requ\xeates."),e.k0s()(),e.j41(295,"tr")(296,"td")(297,"code"),e.EFF(298,"skipIf"),e.k0s()(),e.j41(299,"td"),e.EFF(300,"une fonction qui prend en param\xe8tre le "),e.j41(301,"code"),e.EFF(302,"ExecutionContext"),e.k0s(),e.EFF(303," et renvoie un "),e.j41(304,"code"),e.EFF(305,"boolean"),e.k0s(),e.EFF(306," pour court-circuiter la logique du limitateur. Comme "),e.j41(307,"code"),e.EFF(308,"@SkipThrottler()"),e.k0s(),e.EFF(309,", mais sur la base de la requ\xeate"),e.k0s()()(),e.j41(310,"p"),e.EFF(311,"Si vous avez besoin de configurer le stockage \xe0 la place, ou si vous voulez utiliser certaines des options ci-dessus de mani\xe8re plus globale, en les appliquant \xe0 chaque ensemble de limitateurs, vous pouvez passer les options ci-dessus via la cl\xe9 d'option "),e.j41(312,"code"),e.EFF(313,"throttlers"),e.k0s(),e.EFF(314," et utiliser le tableau suivant :"),e.k0s(),e.j41(315,"table")(316,"tr")(317,"td")(318,"code"),e.EFF(319,"storage"),e.k0s()(),e.j41(320,"td"),e.EFF(321,"un service de stockage personnalis\xe9 pour le suivi de la limitation. "),e.j41(322,"a",26),e.EFF(323,"Voir ici."),e.k0s()()(),e.j41(324,"tr")(325,"td")(326,"code"),e.EFF(327,"ignoreUserAgents"),e.k0s()(),e.j41(328,"td"),e.EFF(329,"une liste d'expressions r\xe9guli\xe8res d'agents-utilisateurs \xe0 ignorer pour les limitations de requ\xeates."),e.k0s()(),e.j41(330,"tr")(331,"td")(332,"code"),e.EFF(333,"skipIf"),e.k0s()(),e.j41(334,"td"),e.EFF(335,"une fonction qui prend en param\xe8tre le "),e.j41(336,"code"),e.EFF(337,"ExecutionContext"),e.k0s(),e.EFF(338," et renvoie un "),e.j41(339,"code"),e.EFF(340,"boolean"),e.k0s(),e.EFF(341," pour court-circuiter la logique du limitateur. Comme "),e.j41(342,"code"),e.EFF(343,"@SkipThrottler()"),e.k0s(),e.EFF(344,", mais sur la base de la requ\xeate"),e.k0s()(),e.j41(345,"tr")(346,"td")(347,"code"),e.EFF(348,"throttlers"),e.k0s()(),e.j41(349,"td"),e.EFF(350,"un tableau d'ensembles de limitateurs, d\xe9finis \xe0 l'aide du tableau ci-dessus"),e.k0s()(),e.j41(351,"tr")(352,"td")(353,"code"),e.EFF(354,"errorMessage"),e.k0s()(),e.j41(355,"td"),e.EFF(356,"une "),e.j41(357,"code"),e.EFF(358,"string"),e.k0s(),e.EFF(359," OU une fonction qui prend en compte le "),e.j41(360,"code"),e.EFF(361,"ExecutionContext"),e.k0s(),e.EFF(362," et le "),e.j41(363,"code"),e.EFF(364,"ThrottlerLimitDetail"),e.k0s(),e.EFF(365," et renvoie une "),e.j41(366,"code"),e.EFF(367,"string"),e.k0s(),e.EFF(368," qui remplace le message d'erreur par d\xe9faut du throttler."),e.k0s()(),e.j41(369,"tr")(370,"td")(371,"code"),e.EFF(372,"getTracker"),e.k0s()(),e.j41(373,"td"),e.EFF(374,"une fonction qui prend en compte la "),e.j41(375,"code"),e.EFF(376,"Request"),e.k0s(),e.EFF(377," et renvoie une "),e.j41(378,"code"),e.EFF(379,"string"),e.k0s(),e.EFF(380," pour remplacer la logique par d\xe9faut de la m\xe9thode "),e.j41(381,"code"),e.EFF(382,"getTracker"),e.k0s()()(),e.j41(383,"tr")(384,"td")(385,"code"),e.EFF(386,"generateKey"),e.k0s()(),e.j41(387,"td"),e.EFF(388,"une fonction qui prend en compte le "),e.j41(389,"code"),e.EFF(390,"ExecutionContext"),e.k0s(),e.EFF(391,", la "),e.j41(392,"code"),e.EFF(393,"string"),e.k0s(),e.EFF(394," du tacker et le nom du throttler en tant que "),e.j41(395,"code"),e.EFF(396,"string"),e.k0s(),e.EFF(397," et renvoie une "),e.j41(398,"code"),e.EFF(399,"string"),e.k0s(),e.EFF(400," pour surcharger la cl\xe9 finale qui sera utilis\xe9e pour stocker la valeur de la limite de taux. Cette fonction remplace la logique par d\xe9faut de la m\xe9thode "),e.j41(401,"code"),e.EFF(402,"generateKey"),e.k0s(),e.EFF(403,"."),e.k0s()()(),e.j41(404,"h4",27)(405,"span"),e.EFF(406,"Configuration asynchrone"),e.k0s()(),e.j41(407,"p"),e.EFF(408,"Vous pouvez vouloir obtenir votre configuration de limitation de d\xe9bit de mani\xe8re asynchrone plut\xf4t que synchrone. Vous pouvez utiliser la m\xe9thode "),e.j41(409,"code"),e.EFF(410,"forRootAsync()"),e.k0s(),e.EFF(411,", qui permet l'injection de d\xe9pendance et les m\xe9thodes "),e.j41(412,"code"),e.EFF(413,"async"),e.k0s(),e.EFF(414,"."),e.k0s(),e.j41(415,"p"),e.EFF(416,"Une approche consisterait \xe0 utiliser une fonction factory :"),e.k0s(),e.j41(417,"app-copy-button")(418,"pre")(419,"code",13),e.EFF(420,"\n@Module({\n  imports: [\n    ThrottlerModule.forRootAsync({\n      imports: [ConfigModule],\n      inject: [ConfigService],\n      useFactory: (config: ConfigService) => [\n        {\n          ttl: config.get('THROTTLE_TTL'),\n          limit: config.get('THROTTLE_LIMIT'),\n        },\n      ],\n    }),\n  ],\n})\nexport class AppModule {}\n"),e.k0s()()(),e.j41(421,"p"),e.EFF(422,"Vous pouvez \xe9galement utiliser la syntaxe "),e.j41(423,"code"),e.EFF(424,"useClass"),e.k0s(),e.EFF(425," :"),e.k0s(),e.j41(426,"app-copy-button")(427,"pre")(428,"code",13),e.EFF(429,"\n@Module({\n  imports: [\n    ThrottlerModule.forRootAsync({\n      imports: [ConfigModule],\n      useClass: ThrottlerConfigService,\n    }),\n  ],\n})\nexport class AppModule {}\n"),e.k0s()()(),e.j41(430,"p"),e.EFF(431,"C'est possible, tant que "),e.j41(432,"code"),e.EFF(433,"ThrottlerConfigService"),e.k0s(),e.EFF(434," impl\xe9mente l'interface "),e.j41(435,"code"),e.EFF(436,"ThrottlerOptionsFactory"),e.k0s(),e.EFF(437,"."),e.k0s(),e.j41(438,"h4",28)(439,"span"),e.EFF(440,"Stockages"),e.k0s()(),e.j41(441,"p"),e.EFF(442,"Le stockage int\xe9gr\xe9 est un cache en m\xe9moire qui garde la trace des requ\xeates effectu\xe9es jusqu'\xe0 ce qu'elles aient pass\xe9 le TTL fix\xe9 par les options globales. Vous pouvez ajouter votre propre option de stockage \xe0 l'option "),e.j41(443,"code"),e.EFF(444,"storage"),e.k0s(),e.EFF(445," du "),e.j41(446,"code"),e.EFF(447,"ThrottlerModule"),e.k0s(),e.EFF(448," tant que la classe impl\xe9mente l'interface "),e.j41(449,"code"),e.EFF(450,"ThrottlerStorage"),e.k0s(),e.EFF(451,"."),e.k0s(),e.j41(452,"p"),e.EFF(453,"Pour les serveurs distribu\xe9s, vous pouvez utiliser le fournisseur de stockage communautaire pour "),e.j41(454,"a",29),e.EFF(455,"Redis"),e.k0s(),e.EFF(456," afin de disposer d'une source unique de v\xe9rit\xe9."),e.k0s(),e.j41(457,"blockquote",20)(458,"strong"),e.EFF(459,"Remarque"),e.k0s(),e.j41(460,"code"),e.EFF(461,"ThrottlerStorage"),e.k0s(),e.EFF(462," peut \xeatre import\xe9 depuis "),e.j41(463,"code"),e.EFF(464,"@nestjs/throttler"),e.k0s(),e.EFF(465,".\n"),e.k0s(),e.j41(466,"h4",30)(467,"span"),e.EFF(468,"Helpers de temps"),e.k0s()(),e.j41(469,"p"),e.EFF(470,"Il y a quelques m\xe9thodes d'aide pour rendre les temps plus lisibles si vous pr\xe9f\xe9rez les utiliser plut\xf4t que la d\xe9finition directe. "),e.j41(471,"code"),e.EFF(472,"@nestjs/throttler"),e.k0s(),e.EFF(473," exporte cinq aides diff\xe9rentes, "),e.j41(474,"code"),e.EFF(475,"seconds"),e.k0s(),e.EFF(476,", "),e.j41(477,"code"),e.EFF(478,"minutes"),e.k0s(),e.EFF(479,", "),e.j41(480,"code"),e.EFF(481,"hours"),e.k0s(),e.EFF(482,", "),e.j41(483,"code"),e.EFF(484,"days"),e.k0s(),e.EFF(485,", et "),e.j41(486,"code"),e.EFF(487,"weeks"),e.k0s(),e.EFF(488,". Pour les utiliser, appelez simplement "),e.j41(489,"code"),e.EFF(490,"seconds(5)"),e.k0s(),e.EFF(491," ou n'importe quelle autre aide, et le nombre correct de millisecondes sera retourn\xe9."),e.k0s(),e.j41(492,"h4",31)(493,"span"),e.EFF(494,"Guide de migration"),e.k0s()(),e.j41(495,"p"),e.EFF(496,"Pour la plupart des gens, mettre vos options dans un tableau sera suffisant."),e.k0s(),e.j41(497,"p"),e.EFF(498,"Si vous utilisez un stockage personnalis\xe9, vous devriez mettre vos "),e.j41(499,"code"),e.EFF(500,"ttl"),e.k0s(),e.EFF(501," et "),e.j41(502,"code"),e.EFF(503,"limit"),e.k0s(),e.EFF(504," dans un tableau et les assigner \xe0 la propri\xe9t\xe9 "),e.j41(505,"code"),e.EFF(506,"throttlers"),e.k0s(),e.EFF(507," de l'objet options."),e.k0s(),e.j41(508,"p"),e.EFF(509,"Tout "),e.j41(510,"code"),e.EFF(511,"@ThrottleSkip()"),e.k0s(),e.EFF(512," devrait maintenant recevoir un objet avec des props "),e.j41(513,"code"),e.EFF(514,"string : boolean"),e.k0s(),e.EFF(515,". Les cha\xeenes de caract\xe8res sont les noms des limitateurs. Si vous n'avez pas de nom, passez la cha\xeene "),e.j41(516,"code"),e.EFF(517,"'default'"),e.k0s(),e.EFF(518,", car c'est ce qui sera utilis\xe9 sous le capot sinon."),e.k0s(),e.j41(519,"p"),e.EFF(520,"Tous les d\xe9corateurs "),e.j41(521,"code"),e.EFF(522,"@Throttle()"),e.k0s(),e.EFF(523," devraient aussi maintenant prendre un objet avec des cl\xe9s de type cha\xeene de caract\xe8res, relatives aux noms des contextes du limitateur (encore une fois, "),e.j41(524,"code"),e.EFF(525,"'default'"),e.k0s(),e.EFF(526," si aucun nom) et aux valeurs des objets qui ont les cl\xe9s "),e.j41(527,"code"),e.EFF(528,"limit"),e.k0s(),e.EFF(529," et "),e.j41(530,"code"),e.EFF(531,"ttl"),e.k0s(),e.EFF(532,"."),e.k0s(),e.j41(533,"blockquote",32)(534,"strong"),e.EFF(535,"Important"),e.k0s(),e.EFF(536," Le "),e.j41(537,"code"),e.EFF(538,"ttl"),e.k0s(),e.EFF(539," est maintenant en "),e.j41(540,"strong"),e.EFF(541,"millisecondes"),e.k0s(),e.EFF(542,". Si vous voulez garder votre ttl en secondes pour plus de lisibilit\xe9, utilisez l'aide "),e.j41(543,"code"),e.EFF(544,"seconds"),e.k0s(),e.EFF(545," de ce package. Il multiplie simplement le ttl par 1000 pour le rendre en millisecondes.\n"),e.k0s(),e.j41(546,"p"),e.EFF(547,"Pour plus d'informations, voir le "),e.j41(548,"a",33),e.EFF(549,"Changelog"),e.k0s()()()),2&n){const d=e.sdS(34),u=e.sdS(74),i=e.sdS(149),a=e.sdS(175);e.R7$(31),e.SpI(" ",e.i5U(32,10,"app.module",d.isJsActive),"\n"),e.R7$(40),e.SpI(" ",e.i5U(72,13,"app.module",u.isJsActive),"\n"),e.R7$(22),e.Lme("","{"," default : true ","}",""),e.R7$(53),e.SpI(" ",e.i5U(147,16,"main.ts",i.isJsActive),"\n"),e.R7$(4),e.AVh("hide",i.isJsActive),e.R7$(3),e.AVh("hide",!i.isJsActive),e.R7$(19),e.SpI(" ",e.i5U(173,19,"throttler-behind-proxy.guard",a.isJsActive),"\n")}},dependencies:[m.O,l.a,p.z,E.Wk,f.M],encapsulation:2,changeDetection:0})}return t})(),data:{title:"Limitation du d\xe9bit"}},{path:"authorization",component:(()=>{class t extends c.y{static \u0275fac=(()=>{let s;return function(o){return(s||(s=e.xGo(t)))(o||t)}})();static \u0275cmp=e.VBU({type:t,selectors:[["app-authorization"]],features:[e.Vt3],decls:608,vars:36,consts:[["contentReference",""],["app5f8e8fe1db73cca1cfda9d687629602420cbee84",""],["appb49c43a873f44a730bf400a58618992232acb41e",""],["app8792e1e5bc2e853b0f7ffada7d601eca707ee522",""],["app619ff1ede1053a1152221210c52eb35a0575a303",""],["app7730d2a9dcb444c4b97c1f145470077f35a3db44",""],[1,"content"],[1,"github-links"],["href","https://github.com/Lou8is/docs.nestjs.fr/edit/main/content/security/authorization.md","aria-label","Proposer des modifications","title","Proposer des modifications"],[1,"fas","fa-edit"],["id","autorisation"],["appAnchor","","id","mise-en-\u0153uvre-dun-syst\xe8me-rbac-de-base"],["routerLink","/guards"],[1,"with-heading"],[1,"filename"],[1,"language-typescript"],[1,"info"],["href","/fundamentals/execution-context#r%C3%A9flexion-et-m%C3%A9tadonn%C3%A9es"],[1,"warning"],["routerLink","/security/authentication"],["appAnchor","","id","autorisation-bas\xe9e-sur-les-revendications"],["href","/security/authorization#mise-en-%C5%93uvre-dun-syst%C3%A8me-rbac-de-base"],["appAnchor","","id","int\xe9gration-de-casl"],["rel","nofollow","target","_blank","href","https://casl.js.org/"],[1,"language-bash"],["rel","nofollow","target","_blank","href","https://casl.js.org/v6/en/guide/subject-type-detection#use-classes-as-subject-types"],["rel","nofollow","target","_blank","href","https://casl.js.org/v6/en/guide/intro"],["appAnchor","","id","avanc\xe9--impl\xe9mentation-dune-policiesguard"],["routerLink","/fundamentals/module-ref"]],template:function(n,o){if(1&n&&(e.j41(0,"div",6,0)(2,"div",7)(3,"a",8),e.nrm(4,"i",9),e.k0s()(),e.j41(5,"h3",10),e.EFF(6,"Autorisation"),e.k0s(),e.j41(7,"p")(8,"strong"),e.EFF(9,"L'autorisation"),e.k0s(),e.EFF(10," est le processus qui d\xe9termine ce qu'un utilisateur peut faire. Par exemple, un utilisateur administrateur est autoris\xe9 \xe0 cr\xe9er, modifier et supprimer des messages. Un utilisateur non administrateur n'est autoris\xe9 qu'\xe0 lire les messages."),e.k0s(),e.j41(11,"p"),e.EFF(12,"L'autorisation est orthogonale et ind\xe9pendante de l'authentification. Cependant, l'autorisation n\xe9cessite un m\xe9canisme d'authentification."),e.k0s(),e.j41(13,"p"),e.EFF(14,"Il existe de nombreuses approches et strat\xe9gies diff\xe9rentes pour g\xe9rer les autorisations. L'approche adopt\xe9e pour un projet d\xe9pend des exigences particuli\xe8res de l'application. Ce chapitre pr\xe9sente quelques approches de l'autorisation qui peuvent \xeatre adapt\xe9es \xe0 un grand nombre d'exigences diff\xe9rentes."),e.k0s(),e.j41(15,"h4",11)(16,"span"),e.EFF(17,"Mise en \u0153uvre d'un syst\xe8me RBAC de base"),e.k0s()(),e.j41(18,"p"),e.EFF(19,"Le contr\xf4le d'acc\xe8s bas\xe9 sur les r\xf4les ("),e.j41(20,"strong"),e.EFF(21,"RBAC"),e.k0s(),e.EFF(22,", pour Role-based access control) est un m\xe9canisme de contr\xf4le d'acc\xe8s neutre d\xe9fini autour des r\xf4les et des privil\xe8ges. Dans cette section, nous allons montrer comment impl\xe9menter un m\xe9canisme RBAC tr\xe8s basique en utilisant des "),e.j41(23,"a",12),e.EFF(24,"gardes"),e.k0s(),e.EFF(25," Nest."),e.k0s(),e.j41(26,"p"),e.EFF(27,"Tout d'abord, cr\xe9ons un enum "),e.j41(28,"code"),e.EFF(29,"Role"),e.k0s(),e.EFF(30," repr\xe9sentant les r\xf4les dans le syst\xe8me :"),e.k0s(),e.j41(31,"app-copy-button",13)(32,"span",14),e.EFF(33),e.nI1(34,"extension"),e.nrm(35,"app-tabs",null,1),e.k0s(),e.j41(37,"pre")(38,"code",15),e.EFF(39,"\nexport enum Role {\n  User = 'user',\n  Admin = 'admin',\n}\n"),e.k0s()()(),e.j41(40,"blockquote",16)(41,"strong"),e.EFF(42,"Astuce"),e.k0s(),e.EFF(43," Dans les syst\xe8mes plus sophistiqu\xe9s, vous pouvez stocker les r\xf4les dans une base de donn\xe9es ou les extraire du fournisseur d'authentification externe.\n"),e.k0s(),e.j41(44,"p"),e.EFF(45,"Avec cela en place, nous pouvons cr\xe9er un d\xe9corateur "),e.j41(46,"code"),e.EFF(47,"@Roles()"),e.k0s(),e.EFF(48,". Ce d\xe9corateur permet de sp\xe9cifier les r\xf4les requis pour acc\xe9der \xe0 des ressources sp\xe9cifiques."),e.k0s(),e.j41(49,"app-copy-button",13)(50,"span",14),e.EFF(51),e.nI1(52,"extension"),e.nrm(53,"app-tabs",null,2),e.k0s(),e.j41(55,"pre")(56,"code",15),e.EFF(57,"\nimport { SetMetadata } from '@nestjs/common';\nimport { Role } from '../enums/role.enum';\n\nexport const ROLES_KEY = 'roles';\nexport const Roles = (...roles: Role[]) => SetMetadata(ROLES_KEY, roles);\n"),e.k0s()(),e.j41(58,"pre")(59,"code",15),e.EFF(60,"\nimport { SetMetadata } from '@nestjs/common';\n\nexport const ROLES_KEY = 'roles';\nexport const Roles = (...roles) => SetMetadata(ROLES_KEY, roles);\n"),e.k0s()()(),e.j41(61,"p"),e.EFF(62,"Maintenant que nous avons un d\xe9corateur personnalis\xe9 "),e.j41(63,"code"),e.EFF(64,"@Roles()"),e.k0s(),e.EFF(65,", nous pouvons l'utiliser pour d\xe9corer n'importe quel gestionnaire de route."),e.k0s(),e.j41(66,"app-copy-button",13)(67,"span",14),e.EFF(68),e.nI1(69,"extension"),e.nrm(70,"app-tabs",null,3),e.k0s(),e.j41(72,"pre")(73,"code",15),e.EFF(74,"\n@Post()\n@Roles(Role.Admin)\ncreate(@Body() createCatDto: CreateCatDto) {\n  this.catsService.create(createCatDto);\n}\n"),e.k0s()(),e.j41(75,"pre")(76,"code",15),e.EFF(77,"\n@Post()\n@Roles(Role.Admin)\n@Bind(Body())\ncreate(createCatDto) {\n  this.catsService.create(createCatDto);\n}\n"),e.k0s()()(),e.j41(78,"p"),e.EFF(79,"Enfin, nous cr\xe9ons une classe "),e.j41(80,"code"),e.EFF(81,"RolesGuard"),e.k0s(),e.EFF(82," qui va comparer les r\xf4les assign\xe9s \xe0 l'utilisateur actuel aux r\xf4les r\xe9els requis par la route en cours de traitement. Afin d'acc\xe9der au(x) r\xf4le(s) de la route (m\xe9tadonn\xe9es personnalis\xe9es), nous allons utiliser la classe d'aide "),e.j41(83,"code"),e.EFF(84,"Reflector"),e.k0s(),e.EFF(85,", qui est fournie par le framework et expos\xe9e dans le package "),e.j41(86,"code"),e.EFF(87,"@nestjs/core"),e.k0s(),e.EFF(88,"."),e.k0s(),e.j41(89,"app-copy-button",13)(90,"span",14),e.EFF(91),e.nI1(92,"extension"),e.nrm(93,"app-tabs",null,4),e.k0s(),e.j41(95,"pre")(96,"code",15),e.EFF(97,"\nimport { Injectable, CanActivate, ExecutionContext } from '@nestjs/common';\nimport { Reflector } from '@nestjs/core';\n\n@Injectable()\nexport class RolesGuard implements CanActivate {\n  constructor(private reflector: Reflector) {}\n\n  canActivate(context: ExecutionContext): boolean {\n    const requiredRoles = this.reflector.getAllAndOverride<Role[]>(ROLES_KEY, [\n      context.getHandler(),\n      context.getClass(),\n    ]);\n    if (!requiredRoles) {\n      return true;\n    }\n    const { user } = context.switchToHttp().getRequest();\n    return requiredRoles.some((role) => user.roles?.includes(role));\n  }\n}\n"),e.k0s()(),e.j41(98,"pre")(99,"code",15),e.EFF(100,"\nimport { Injectable, Dependencies } from '@nestjs/common';\nimport { Reflector } from '@nestjs/core';\n\n@Injectable()\n@Dependencies(Reflector)\nexport class RolesGuard {\n  constructor(reflector) {\n    this.reflector = reflector;\n  }\n\n  canActivate(context) {\n    const requiredRoles = this.reflector.getAllAndOverride(ROLES_KEY, [\n      context.getHandler(),\n      context.getClass(),\n    ]);\n    if (!requiredRoles) {\n      return true;\n    }\n    const { user } = context.switchToHttp().getRequest();\n    return requiredRoles.some((role) => user.roles.includes(role));\n  }\n}\n"),e.k0s()()(),e.j41(101,"blockquote",16)(102,"strong"),e.EFF(103,"Astuce"),e.k0s(),e.EFF(104," R\xe9f\xe9rez-vous \xe0 la section "),e.j41(105,"a",17),e.EFF(106,"R\xe9flexion et m\xe9tadonn\xe9es"),e.k0s(),e.EFF(107," du chapitre sur le contexte d'ex\xe9cution pour plus de d\xe9tails sur l'utilisation de "),e.j41(108,"code"),e.EFF(109,"Reflector"),e.k0s(),e.EFF(110," d'une mani\xe8re adapt\xe9e au contexte.\n"),e.k0s(),e.j41(111,"blockquote",18)(112,"strong"),e.EFF(113,"Remarque"),e.k0s(),e.EFF(114,' Cet exemple est appel\xe9 "'),e.j41(115,"strong"),e.EFF(116,"basique"),e.k0s(),e.EFF(117,"\" car nous ne v\xe9rifions la pr\xe9sence de r\xf4les qu'au niveau du gestionnaire d'itin\xe9raire. Dans les applications r\xe9elles, vous pouvez avoir des points de terminaison ou des gestionnaires qui impliquent plusieurs op\xe9rations, dans lesquelles chacune d'entre elles n\xe9cessite un ensemble sp\xe9cifique de permissions. Dans ce cas, vous devrez fournir un m\xe9canisme de v\xe9rification des r\xf4les quelque part dans votre logique d'entreprise, ce qui rendra la maintenance un peu plus difficile car il n'y aura pas d'endroit centralis\xe9 qui associe les permissions \xe0 des actions sp\xe9cifiques.\n"),e.k0s(),e.j41(118,"p"),e.EFF(119,"Dans cet exemple, nous avons suppos\xe9 que "),e.j41(120,"code"),e.EFF(121,"request.user"),e.k0s(),e.EFF(122," contient l'instance de l'utilisateur et les r\xf4les autoris\xe9s (sous la propri\xe9t\xe9 "),e.j41(123,"code"),e.EFF(124,"roles"),e.k0s(),e.EFF(125,"). Dans votre application, vous ferez probablement cette association dans votre "),e.j41(126,"strong"),e.EFF(127,"garde d'authentification"),e.k0s(),e.EFF(128," personnalis\xe9e - voir le chapitre "),e.j41(129,"a",19),e.EFF(130,"authentification"),e.k0s(),e.EFF(131," pour plus de d\xe9tails."),e.k0s(),e.j41(132,"p"),e.EFF(133,"Pour que cet exemple fonctionne, votre classe "),e.j41(134,"code"),e.EFF(135,"User"),e.k0s(),e.EFF(136," doit ressembler \xe0 ce qui suit :"),e.k0s(),e.j41(137,"app-copy-button")(138,"pre")(139,"code",15),e.EFF(140,"\nclass User {\n  // ...autres propri\xe9t\xe9s\n  roles: Role[];\n}\n"),e.k0s()()(),e.j41(141,"p"),e.EFF(142,"Enfin, assurez-vous d'enregistrer la garde "),e.j41(143,"code"),e.EFF(144,"RolesGuard"),e.k0s(),e.EFF(145,", par exemple, au niveau du contr\xf4leur, ou globalement :"),e.k0s(),e.j41(146,"app-copy-button")(147,"pre")(148,"code",15),e.EFF(149,"\nproviders: [\n  {\n    provide: APP_GUARD,\n    useClass: RolesGuard,\n  },\n],\n"),e.k0s()()(),e.j41(150,"p"),e.EFF(151,"Lorsqu'un utilisateur ne disposant pas de privil\xe8ges suffisants effectue une requ\xeate sur un point d'acc\xe8s, Nest renvoie automatiquement la r\xe9ponse suivante :"),e.k0s(),e.j41(152,"app-copy-button")(153,"pre")(154,"code",15),e.EFF(155,'\n{\n  "statusCode": 403,\n  "message": "Forbidden resource",\n  "error": "Forbidden"\n}\n'),e.k0s()()(),e.j41(156,"blockquote",16)(157,"strong"),e.EFF(158,"Astuce"),e.k0s(),e.EFF(159," Si vous souhaitez renvoyer une r\xe9ponse d'erreur diff\xe9rente, vous devez lancer votre propre exception sp\xe9cifique au lieu de renvoyer une valeur bool\xe9enne.\n"),e.k0s(),e.j41(160,"p"),e.nrm(161,"app-banner-courses-auth"),e.k0s(),e.j41(162,"h4",20)(163,"span"),e.EFF(164,"Autorisation bas\xe9e sur les revendications"),e.k0s()(),e.j41(165,"p"),e.EFF(166,"Lorsqu'une identit\xe9 est cr\xe9\xe9e, elle peut se voir attribuer une ou plusieurs revendications \xe9mises par un tiers de confiance. Une revendication est une paire nom-valeur qui repr\xe9sente ce que le sujet peut faire, et non ce qu'il est."),e.k0s(),e.j41(167,"p"),e.EFF(168,"Pour mettre en \u0153uvre une autorisation bas\xe9e sur les revendications dans Nest, vous pouvez suivre les m\xeames \xe9tapes que nous avons montr\xe9es ci-dessus dans la section "),e.j41(169,"a",21),e.EFF(170,"RBAC"),e.k0s(),e.EFF(171," avec une diff\xe9rence importante : au lieu de v\xe9rifier les r\xf4les sp\xe9cifiques, vous devez comparer les "),e.j41(172,"strong"),e.EFF(173,"permissions"),e.k0s(),e.EFF(174,". Chaque utilisateur se voit attribuer un ensemble de permissions. De m\xeame, chaque ressource ou point de terminaison d\xe9finirait les permissions requises (par exemple, \xe0 travers un d\xe9corateur "),e.j41(175,"code"),e.EFF(176,"@RequirePermissions()"),e.k0s(),e.EFF(177," d\xe9di\xe9) pour y acc\xe9der."),e.k0s(),e.j41(178,"app-copy-button",13)(179,"span",14),e.EFF(180),e.nI1(181,"extension"),e.nrm(182,"app-tabs",null,5),e.k0s(),e.j41(184,"pre")(185,"code",15),e.EFF(186,"\n@Post()\n@RequirePermissions(Permission.CREATE_CAT)\ncreate(@Body() createCatDto: CreateCatDto) {\n  this.catsService.create(createCatDto);\n}\n"),e.k0s()(),e.j41(187,"pre")(188,"code",15),e.EFF(189,"\n@Post()\n@RequirePermissions(Permission.CREATE_CAT)\n@Bind(Body())\ncreate(createCatDto) {\n  this.catsService.create(createCatDto);\n}\n"),e.k0s()()(),e.j41(190,"blockquote",16)(191,"strong"),e.EFF(192,"Astuce"),e.k0s(),e.EFF(193," Dans l'exemple ci-dessus, "),e.j41(194,"code"),e.EFF(195,"Permission"),e.k0s(),e.EFF(196," (similaire \xe0 "),e.j41(197,"code"),e.EFF(198,"Role"),e.k0s(),e.EFF(199," que nous avons montr\xe9 dans la section RBAC) est une \xe9num\xe9ration TypeScript qui contient toutes les permissions disponibles dans votre syst\xe8me.\n"),e.k0s(),e.j41(200,"h4",22)(201,"span"),e.EFF(202,"Int\xe9gration de CASL"),e.k0s()(),e.j41(203,"p")(204,"a",23),e.EFF(205,"CASL"),e.k0s(),e.EFF(206," est une biblioth\xe8que d'autorisation isomorphe qui restreint les ressources auxquelles un client donn\xe9 est autoris\xe9 \xe0 acc\xe9der. Elle est con\xe7ue pour \xeatre adopt\xe9e de mani\xe8re incr\xe9mentale et peut facilement \xe9voluer entre une simple autorisation bas\xe9e sur les revendications et une autorisation compl\xe8te bas\xe9e sur les sujets et les attributs."),e.k0s(),e.j41(207,"p"),e.EFF(208,"Pour commencer, installez d'abord le package "),e.j41(209,"code"),e.EFF(210,"@casl/ability"),e.k0s(),e.EFF(211," :"),e.k0s(),e.j41(212,"pre")(213,"code",24),e.EFF(214,"\n$ npm i @casl/ability\n"),e.k0s()(),e.j41(215,"blockquote",16)(216,"strong"),e.EFF(217,"Astuce"),e.k0s(),e.EFF(218," Dans cet exemple, nous avons choisi CASL, mais vous pouvez utiliser n'importe quelle autre biblioth\xe8que comme "),e.j41(219,"code"),e.EFF(220,"accesscontrol"),e.k0s(),e.EFF(221," ou "),e.j41(222,"code"),e.EFF(223,"acl"),e.k0s(),e.EFF(224,", en fonction de vos pr\xe9f\xe9rences et des besoins de votre projet.\n"),e.k0s(),e.j41(225,"p"),e.EFF(226,"Une fois l'installation termin\xe9e, pour illustrer les m\xe9canismes de la CASL, nous allons d\xe9finir deux classes d'entit\xe9s : "),e.j41(227,"code"),e.EFF(228,"User"),e.k0s(),e.EFF(229," et "),e.j41(230,"code"),e.EFF(231,"Article"),e.k0s(),e.EFF(232,"."),e.k0s(),e.j41(233,"app-copy-button")(234,"pre")(235,"code",15),e.EFF(236,"\nclass User {\n  id: number;\n  isAdmin: boolean;\n}\n"),e.k0s()()(),e.j41(237,"p"),e.EFF(238,"La classe "),e.j41(239,"code"),e.EFF(240,"User"),e.k0s(),e.EFF(241," est constitu\xe9e de deux propri\xe9t\xe9s, "),e.j41(242,"code"),e.EFF(243,"id"),e.k0s(),e.EFF(244,", qui est un identifiant unique de l'utilisateur, et "),e.j41(245,"code"),e.EFF(246,"isAdmin"),e.k0s(),e.EFF(247,", qui indique si l'utilisateur a des privil\xe8ges d'administrateur."),e.k0s(),e.j41(248,"app-copy-button")(249,"pre")(250,"code",15),e.EFF(251,"\nclass Article {\n  id: number;\n  isPublished: boolean;\n  authorId: number;\n}\n"),e.k0s()()(),e.j41(252,"p"),e.EFF(253,"La classe "),e.j41(254,"code"),e.EFF(255,"Article"),e.k0s(),e.EFF(256," poss\xe8de trois propri\xe9t\xe9s, respectivement "),e.j41(257,"code"),e.EFF(258,"id"),e.k0s(),e.EFF(259,", "),e.j41(260,"code"),e.EFF(261,"isPublished"),e.k0s(),e.EFF(262,", et "),e.j41(263,"code"),e.EFF(264,"authorId"),e.k0s(),e.EFF(265,". "),e.j41(266,"code"),e.EFF(267,"id"),e.k0s(),e.EFF(268," est un identifiant unique de l'article, "),e.j41(269,"code"),e.EFF(270,"isPublished"),e.k0s(),e.EFF(271," indique si l'article a d\xe9j\xe0 \xe9t\xe9 publi\xe9 ou non, et "),e.j41(272,"code"),e.EFF(273,"authorId"),e.k0s(),e.EFF(274,", qui est l'identifiant de l'utilisateur qui a \xe9crit l'article."),e.k0s(),e.j41(275,"p"),e.EFF(276,"Passons maintenant en revue et affinons nos exigences pour cet exemple :"),e.k0s(),e.j41(277,"ul")(278,"li"),e.EFF(279,"Les administrateurs peuvent g\xe9rer (cr\xe9er/lire/mettre \xe0 jour/supprimer) toutes les entit\xe9s."),e.k0s(),e.j41(280,"li"),e.EFF(281,"Les utilisateurs ont un acc\xe8s en lecture seule \xe0 tout"),e.k0s(),e.j41(282,"li"),e.EFF(283,"Les utilisateurs peuvent mettre \xe0 jour leurs articles ("),e.j41(284,"code"),e.EFF(285,"article.authorId === userId"),e.k0s(),e.EFF(286,")"),e.k0s(),e.j41(287,"li"),e.EFF(288,"Les articles d\xe9j\xe0 publi\xe9s ne peuvent pas \xeatre supprim\xe9s ("),e.j41(289,"code"),e.EFF(290,"article.isPublished === true"),e.k0s(),e.EFF(291,")"),e.k0s()(),e.j41(292,"p"),e.EFF(293,"En gardant cela \xe0 l'esprit, nous pouvons commencer par cr\xe9er un enum "),e.j41(294,"code"),e.EFF(295,"Action"),e.k0s(),e.EFF(296," repr\xe9sentant toutes les actions possibles que les utilisateurs peuvent effectuer avec les entit\xe9s :"),e.k0s(),e.j41(297,"app-copy-button")(298,"pre")(299,"code",15),e.EFF(300,"\nexport enum Action {\n  Manage = 'manage',\n  Create = 'create',\n  Read = 'read',\n  Update = 'update',\n  Delete = 'delete',\n}\n"),e.k0s()()(),e.j41(301,"blockquote",18)(302,"strong"),e.EFF(303,"Remarque"),e.k0s(),e.j41(304,"code"),e.EFF(305,"manage"),e.k0s(),e.EFF(306,' est un mot-cl\xe9 sp\xe9cial de la CASL qui repr\xe9sente "toute" action.\n'),e.k0s(),e.j41(307,"p"),e.EFF(308,"Pour encapsuler la biblioth\xe8que CASL, g\xe9n\xe9rons maintenant le "),e.j41(309,"code"),e.EFF(310,"CaslModule"),e.k0s(),e.EFF(311," et le "),e.j41(312,"code"),e.EFF(313,"CaslAbilityFactory"),e.k0s(),e.EFF(314,"."),e.k0s(),e.j41(315,"pre")(316,"code",24),e.EFF(317,"\n$ nest g module casl\n$ nest g class casl/casl-ability.factory\n"),e.k0s()(),e.j41(318,"p"),e.EFF(319,"Avec ceci en place, nous pouvons d\xe9finir la m\xe9thode "),e.j41(320,"code"),e.EFF(321,"createForUser()"),e.k0s(),e.EFF(322," sur la "),e.j41(323,"code"),e.EFF(324,"CaslAbilityFactory"),e.k0s(),e.EFF(325,". Cette m\xe9thode va cr\xe9er l'objet "),e.j41(326,"code"),e.EFF(327,"Ability"),e.k0s(),e.EFF(328," pour un utilisateur donn\xe9 :"),e.k0s(),e.j41(329,"app-copy-button")(330,"pre")(331,"code",15),e.EFF(332,"\ntype Subjects = InferSubjects<typeof Article | typeof User> | 'all';\n\nexport type AppAbility = Ability<[Action, Subjects]>;\n\n@Injectable()\nexport class CaslAbilityFactory {\n  createForUser(user: User) {\n    const { can, cannot, build } = new AbilityBuilder<\n      Ability<[Action, Subjects]>\n    >(Ability as AbilityClass<AppAbility>);\n\n    if (user.isAdmin) {\n      can(Action.Manage, 'all'); // acc\xe8s en lecture/\xe9criture \xe0 tout\n    } else {\n      can(Action.Read, 'all'); // acc\xe8s en lecture seule \xe0 tout\n    }\n\n    can(Action.Update, Article, { authorId: user.id });\n    cannot(Action.Delete, Article, { isPublished: true });\n\n    return build({\n      // Lire https://casl.js.org/v6/en/guide/subject-type-detection#use-classes-as-subject-types pour plus de d\xe9tails\n      detectSubjectType: (item) =>\n        item.constructor as ExtractSubjectType<Subjects>,\n    });\n  }\n}\n"),e.k0s()()(),e.j41(333,"blockquote",18)(334,"strong"),e.EFF(335,"Remarque"),e.k0s(),e.j41(336,"code"),e.EFF(337,"all"),e.k0s(),e.EFF(338,' est un mot-cl\xe9 sp\xe9cial de la CASL qui repr\xe9sente "tout sujet".\n'),e.k0s(),e.j41(339,"blockquote",16)(340,"strong"),e.EFF(341,"Astuce"),e.k0s(),e.EFF(342," Les classes "),e.j41(343,"code"),e.EFF(344,"Ability"),e.k0s(),e.EFF(345,", "),e.j41(346,"code"),e.EFF(347,"AbilityBuilder"),e.k0s(),e.EFF(348,", "),e.j41(349,"code"),e.EFF(350,"AbilityClass"),e.k0s(),e.EFF(351," et "),e.j41(352,"code"),e.EFF(353,"ExtractSubjectType"),e.k0s(),e.EFF(354," sont export\xe9es depuis le package "),e.j41(355,"code"),e.EFF(356,"@casl/ability"),e.k0s(),e.EFF(357,".\n"),e.k0s(),e.j41(358,"blockquote",16)(359,"strong"),e.EFF(360,"Astuce"),e.k0s(),e.EFF(361," L'option "),e.j41(362,"code"),e.EFF(363,"detectSubjectType"),e.k0s(),e.EFF(364," permet \xe0 CASL de comprendre comment extraire le type de sujet d'un objet. Pour plus d'informations, consultez la "),e.j41(365,"a",25),e.EFF(366,"documentation CASL"),e.k0s(),e.EFF(367,".\n"),e.k0s(),e.j41(368,"p"),e.EFF(369,"Dans l'exemple ci-dessus, nous avons cr\xe9\xe9 l'instance "),e.j41(370,"code"),e.EFF(371,"Ability"),e.k0s(),e.EFF(372," en utilisant la classe "),e.j41(373,"code"),e.EFF(374,"AbilityBuilder"),e.k0s(),e.EFF(375,". Comme vous l'avez probablement devin\xe9, "),e.j41(376,"code"),e.EFF(377,"can"),e.k0s(),e.EFF(378," et "),e.j41(379,"code"),e.EFF(380,"cannot"),e.k0s(),e.EFF(381," acceptent les m\xeames arguments mais ont des significations diff\xe9rentes, "),e.j41(382,"code"),e.EFF(383,"can"),e.k0s(),e.EFF(384," permet de faire une action sur le sujet sp\xe9cifi\xe9 et "),e.j41(385,"code"),e.EFF(386,"cannot"),e.k0s(),e.EFF(387," l'interdit. Les deux fonctions peuvent accepter jusqu'\xe0 4 arguments. Pour en savoir plus sur ces fonctions, consultez la "),e.j41(388,"a",26),e.EFF(389,"documentation CASL officielle"),e.k0s(),e.EFF(390,"."),e.k0s(),e.j41(391,"p"),e.EFF(392,"Enfin, assurez-vous d'ajouter la "),e.j41(393,"code"),e.EFF(394,"CaslAbilityFactory"),e.k0s(),e.EFF(395," aux tableaux "),e.j41(396,"code"),e.EFF(397,"providers"),e.k0s(),e.EFF(398," et "),e.j41(399,"code"),e.EFF(400,"exports"),e.k0s(),e.EFF(401," dans la d\xe9finition du module "),e.j41(402,"code"),e.EFF(403,"CaslModule"),e.k0s(),e.EFF(404," :"),e.k0s(),e.j41(405,"app-copy-button")(406,"pre")(407,"code",15),e.EFF(408,"\nimport { Module } from '@nestjs/common';\nimport { CaslAbilityFactory } from './casl-ability.factory';\n\n@Module({\n  providers: [CaslAbilityFactory],\n  exports: [CaslAbilityFactory],\n})\nexport class CaslModule {}\n"),e.k0s()()(),e.j41(409,"p"),e.EFF(410,"Avec ceci en place, nous pouvons injecter la "),e.j41(411,"code"),e.EFF(412,"CaslAbilityFactory"),e.k0s(),e.EFF(413," dans n'importe quelle classe en utilisant l'injection de constructeur standard tant que le "),e.j41(414,"code"),e.EFF(415,"CaslModule"),e.k0s(),e.EFF(416," est import\xe9 dans le contexte de l'h\xf4te :"),e.k0s(),e.j41(417,"app-copy-button")(418,"pre")(419,"code",15),e.EFF(420,"\nconstructor(private caslAbilityFactory: CaslAbilityFactory) {}\n"),e.k0s()()(),e.j41(421,"p"),e.EFF(422,"Utilisez-le ensuite dans une classe comme suit."),e.k0s(),e.j41(423,"app-copy-button")(424,"pre")(425,"code",15),e.EFF(426,"\nconst ability = this.caslAbilityFactory.createForUser(user);\nif (ability.can(Action.Read, 'all')) {\n  // \"user\" a un acc\xe8s en lecture \xe0 tout\n}\n"),e.k0s()()(),e.j41(427,"blockquote",16)(428,"strong"),e.EFF(429,"Astuce"),e.k0s(),e.EFF(430," Pour en savoir plus sur la classe "),e.j41(431,"code"),e.EFF(432,"Ability"),e.k0s(),e.EFF(433,", consultez la "),e.j41(434,"a",26),e.EFF(435,"documentation CASL officielle"),e.k0s(),e.EFF(436,".\n"),e.k0s(),e.j41(437,"p"),e.EFF(438,"Par exemple, supposons qu'un utilisateur ne soit pas un administrateur. Dans ce cas, l'utilisateur doit pouvoir lire les articles, mais la cr\xe9ation de nouveaux articles ou la suppression d'articles existants doit \xeatre interdite."),e.k0s(),e.j41(439,"app-copy-button")(440,"pre")(441,"code",15),e.EFF(442,"\nconst user = new User();\nuser.isAdmin = false;\n\nconst ability = this.caslAbilityFactory.createForUser(user);\nability.can(Action.Read, Article); // true\nability.can(Action.Delete, Article); // false\nability.can(Action.Create, Article); // false\n"),e.k0s()()(),e.j41(443,"blockquote",16)(444,"strong"),e.EFF(445,"Astuce"),e.k0s(),e.EFF(446," Bien que les classes "),e.j41(447,"code"),e.EFF(448,"Ability"),e.k0s(),e.EFF(449," et "),e.j41(450,"code"),e.EFF(451,"AbilityBuilder"),e.k0s(),e.EFF(452," fournissent toutes deux des m\xe9thodes "),e.j41(453,"code"),e.EFF(454,"can"),e.k0s(),e.EFF(455," et "),e.j41(456,"code"),e.EFF(457,"cannot"),e.k0s(),e.EFF(458,", elles ont des objectifs diff\xe9rents et acceptent des arguments l\xe9g\xe8rement diff\xe9rents.\n"),e.k0s(),e.j41(459,"p"),e.EFF(460,"De plus, comme nous l'avons sp\xe9cifi\xe9 dans nos exigences, l'utilisateur doit pouvoir mettre \xe0 jour ses articles :"),e.k0s(),e.j41(461,"app-copy-button")(462,"pre")(463,"code",15),e.EFF(464,"\nconst user = new User();\nuser.id = 1;\n\nconst article = new Article();\narticle.authorId = user.id;\n\nconst ability = this.caslAbilityFactory.createForUser(user);\nability.can(Action.Update, article); // true\n\narticle.authorId = 2;\nability.can(Action.Update, article); // false\n"),e.k0s()()(),e.j41(465,"p"),e.EFF(466,"Comme vous pouvez le voir, l'instance "),e.j41(467,"code"),e.EFF(468,"Ability"),e.k0s(),e.EFF(469," nous permet de v\xe9rifier les permissions d'une mani\xe8re assez lisible. De m\xeame, "),e.j41(470,"code"),e.EFF(471,"AbilityBuilder"),e.k0s(),e.EFF(472," nous permet de d\xe9finir les permissions (et de sp\xe9cifier diverses conditions) de la m\xeame mani\xe8re. Pour plus d'exemples, visitez la documentation officielle."),e.k0s(),e.j41(473,"h4",27)(474,"span"),e.EFF(475,"Avanc\xe9 : Impl\xe9mentation d'une "),e.j41(476,"code"),e.EFF(477,"PoliciesGuard"),e.k0s()()(),e.j41(478,"p"),e.EFF(479,"Dans cette section, nous allons montrer comment construire une garde un peu plus sophistiqu\xe9e, qui v\xe9rifie si un utilisateur r\xe9pond \xe0 des "),e.j41(480,"strong"),e.EFF(481,"politiques d'autorisation"),e.k0s(),e.EFF(482," sp\xe9cifiques qui peuvent \xeatre configur\xe9es au niveau de la m\xe9thode (vous pouvez l'\xe9tendre pour respecter les politiques configur\xe9es au niveau de la classe \xe9galement). Dans cet exemple, nous allons utiliser le package CASL \xe0 des fins d'illustration, mais l'utilisation de cette biblioth\xe8que n'est pas obligatoire. Nous utiliserons \xe9galement le fournisseur "),e.j41(483,"code"),e.EFF(484,"CaslAbilityFactory"),e.k0s(),e.EFF(485," que nous avons cr\xe9\xe9 dans la section pr\xe9c\xe9dente."),e.k0s(),e.j41(486,"p"),e.EFF(487,"Tout d'abord, pr\xe9cisons les exigences. L'objectif est de fournir un m\xe9canisme qui permette de sp\xe9cifier des contr\xf4les de politique par gestionnaire de route. Nous prendrons en charge \xe0 la fois les objets et les fonctions (pour des contr\xf4les plus simples et pour ceux qui pr\xe9f\xe8rent un code plus fonctionnel)."),e.k0s(),e.j41(488,"p"),e.EFF(489,"Commen\xe7ons par d\xe9finir des interfaces pour les gestionnaires de politiques :"),e.k0s(),e.j41(490,"app-copy-button")(491,"pre")(492,"code",15),e.EFF(493,"\nimport { AppAbility } from '../casl/casl-ability.factory';\n\ninterface IPolicyHandler {\n  handle(ability: AppAbility): boolean;\n}\n\ntype PolicyHandlerCallback = (ability: AppAbility) => boolean;\n\nexport type PolicyHandler = IPolicyHandler | PolicyHandlerCallback;\n"),e.k0s()()(),e.j41(494,"p"),e.EFF(495,"Comme mentionn\xe9 plus haut, nous avons propos\xe9 deux fa\xe7ons de d\xe9finir un gestionnaire de politique : un objet (instance d'une classe qui impl\xe9mente l'interface "),e.j41(496,"code"),e.EFF(497,"IPolicyHandler"),e.k0s(),e.EFF(498,") et une fonction (qui r\xe9pond au type "),e.j41(499,"code"),e.EFF(500,"PolicyHandlerCallback"),e.k0s(),e.EFF(501,")."),e.k0s(),e.j41(502,"p"),e.EFF(503,"Avec cela en place, nous pouvons cr\xe9er un d\xe9corateur "),e.j41(504,"code"),e.EFF(505,"@CheckPolicies()"),e.k0s(),e.EFF(506,". Ce d\xe9corateur permet de sp\xe9cifier quelles politiques doivent \xeatre respect\xe9es pour acc\xe9der \xe0 des ressources sp\xe9cifiques."),e.k0s(),e.j41(507,"app-copy-button")(508,"pre")(509,"code",15),e.EFF(510,"\nexport const CHECK_POLICIES_KEY = 'check_policy';\nexport const CheckPolicies = (...handlers: PolicyHandler[]) =>\n  SetMetadata(CHECK_POLICIES_KEY, handlers);\n"),e.k0s()()(),e.j41(511,"p"),e.EFF(512,"Maintenant, cr\xe9ons une "),e.j41(513,"code"),e.EFF(514,"PoliciesGuard"),e.k0s(),e.EFF(515," qui va extraire et ex\xe9cuter tous les policy handlers li\xe9s \xe0 un gestionnaire de route."),e.k0s(),e.j41(516,"app-copy-button")(517,"pre")(518,"code",15),e.EFF(519,"\n@Injectable()\nexport class PoliciesGuard implements CanActivate {\n  constructor(\n    private reflector: Reflector,\n    private caslAbilityFactory: CaslAbilityFactory,\n  ) {}\n\n  async canActivate(context: ExecutionContext): Promise<boolean> {\n    const policyHandlers =\n      this.reflector.get<PolicyHandler[]>(\n        CHECK_POLICIES_KEY,\n        context.getHandler(),\n      ) || [];\n\n    const { user } = context.switchToHttp().getRequest();\n    const ability = this.caslAbilityFactory.createForUser(user);\n\n    return policyHandlers.every((handler) =>\n      this.execPolicyHandler(handler, ability),\n    );\n  }\n\n  private execPolicyHandler(handler: PolicyHandler, ability: AppAbility) {\n    if (typeof handler === 'function') {\n      return handler(ability);\n    }\n    return handler.handle(ability);\n  }\n}\n"),e.k0s()()(),e.j41(520,"blockquote",16)(521,"strong"),e.EFF(522,"Astuce"),e.k0s(),e.EFF(523," Dans cet exemple, nous avons suppos\xe9 que "),e.j41(524,"code"),e.EFF(525,"request.user"),e.k0s(),e.EFF(526," contient l'instance de l'utilisateur. Dans votre application, vous ferez probablement cette association dans votre "),e.j41(527,"strong"),e.EFF(528,"garde d'authentification"),e.k0s(),e.EFF(529," personnalis\xe9e - voir le chapitre "),e.j41(530,"a",19),e.EFF(531,"authentification"),e.k0s(),e.EFF(532," pour plus de d\xe9tails.\n"),e.k0s(),e.j41(533,"p"),e.EFF(534,"D\xe9composons cet exemple. Le "),e.j41(535,"code"),e.EFF(536,"policyHandlers"),e.k0s(),e.EFF(537," est un tableau de handlers assign\xe9s \xe0 la m\xe9thode par le d\xe9corateur "),e.j41(538,"code"),e.EFF(539,"@CheckPolicies()"),e.k0s(),e.EFF(540,". Ensuite, nous utilisons la m\xe9thode "),e.j41(541,"code"),e.EFF(542,"CaslAbilityFactory#create"),e.k0s(),e.EFF(543," qui construit l'objet "),e.j41(544,"code"),e.EFF(545,"Ability"),e.k0s(),e.EFF(546,", nous permettant de v\xe9rifier si un utilisateur a les permissions suffisantes pour effectuer des actions sp\xe9cifiques. Nous passons cet objet au gestionnaire de politique qui est soit une fonction, soit une instance d'une classe qui impl\xe9mente le "),e.j41(547,"code"),e.EFF(548,"IPolicyHandler"),e.k0s(),e.EFF(549,", exposant la m\xe9thode "),e.j41(550,"code"),e.EFF(551,"handle()"),e.k0s(),e.EFF(552," qui retourne un bool\xe9en. Enfin, nous utilisons la m\xe9thode "),e.j41(553,"code"),e.EFF(554,"Array#every"),e.k0s(),e.EFF(555," pour nous assurer que chaque handler renvoie la valeur "),e.j41(556,"code"),e.EFF(557,"true"),e.k0s(),e.EFF(558,"."),e.k0s(),e.j41(559,"p"),e.EFF(560,"Enfin, pour tester cette garde, liez-la \xe0 n'importe quel gestionnaire de route et enregistrez un gestionnaire de politique en ligne (approche fonctionnelle), comme suit :"),e.k0s(),e.j41(561,"app-copy-button")(562,"pre")(563,"code",15),e.EFF(564,"\n@Get()\n@UseGuards(PoliciesGuard)\n@CheckPolicies((ability: AppAbility) => ability.can(Action.Read, Article))\nfindAll() {\n  return this.articlesService.findAll();\n}\n"),e.k0s()()(),e.j41(565,"p"),e.EFF(566,"Alternativement, nous pouvons d\xe9finir une classe qui impl\xe9mente l'interface "),e.j41(567,"code"),e.EFF(568,"IPolicyHandler"),e.k0s(),e.EFF(569," :"),e.k0s(),e.j41(570,"app-copy-button")(571,"pre")(572,"code",15),e.EFF(573,"\nexport class ReadArticlePolicyHandler implements IPolicyHandler {\n  handle(ability: AppAbility) {\n    return ability.can(Action.Read, Article);\n  }\n}\n"),e.k0s()()(),e.j41(574,"p"),e.EFF(575,"Et l'utiliser comme suit :"),e.k0s(),e.j41(576,"app-copy-button")(577,"pre")(578,"code",15),e.EFF(579,"\n@Get()\n@UseGuards(PoliciesGuard)\n@CheckPolicies(new ReadArticlePolicyHandler())\nfindAll() {\n  return this.articlesService.findAll();\n}\n"),e.k0s()()(),e.j41(580,"blockquote",18)(581,"strong"),e.EFF(582,"Remarque"),e.k0s(),e.EFF(583," Puisque nous devons instancier le gestionnaire de politique sur place en utilisant le mot-cl\xe9 "),e.j41(584,"code"),e.EFF(585,"new"),e.k0s(),e.EFF(586,", la classe "),e.j41(587,"code"),e.EFF(588,"ReadArticlePolicyHandler"),e.k0s(),e.EFF(589," ne peut pas utiliser l'injection de d\xe9pendance. Ceci peut \xeatre r\xe9solu avec la m\xe9thode "),e.j41(590,"code"),e.EFF(591,"ModuleRef#get"),e.k0s(),e.EFF(592," (en savoir plus "),e.j41(593,"a",28),e.EFF(594,"ici"),e.k0s(),e.EFF(595,"). En fait, au lieu d'enregistrer des fonctions et des instances \xe0 travers le d\xe9corateur "),e.j41(596,"code"),e.EFF(597,"@CheckPolicies()"),e.k0s(),e.EFF(598,", vous devez autoriser le passage d'un "),e.j41(599,"code"),e.EFF(600,"Type<IPolicyHandler>"),e.k0s(),e.EFF(601,". Ensuite, \xe0 l'int\xe9rieur de votre garde, vous pouvez r\xe9cup\xe9rer une instance en utilisant une r\xe9f\xe9rence de type : "),e.j41(602,"code"),e.EFF(603,"moduleRef.get(YOUR_HANDLER_TYPE)"),e.k0s(),e.EFF(604," ou m\xeame l'instancier dynamiquement en utilisant la m\xe9thode "),e.j41(605,"code"),e.EFF(606,"ModuleRef#create"),e.k0s(),e.EFF(607,".\n"),e.k0s()()),2&n){const d=e.sdS(36),u=e.sdS(54),i=e.sdS(71),a=e.sdS(94),F=e.sdS(183);e.R7$(33),e.SpI(" ",e.i5U(34,21,"role.enum",d.isJsActive),"\n"),e.R7$(18),e.SpI(" ",e.i5U(52,24,"roles.decorator",u.isJsActive),"\n"),e.R7$(4),e.AVh("hide",u.isJsActive),e.R7$(3),e.AVh("hide",!u.isJsActive),e.R7$(10),e.SpI(" ",e.i5U(69,27,"cats.controller",i.isJsActive),"\n"),e.R7$(4),e.AVh("hide",i.isJsActive),e.R7$(3),e.AVh("hide",!i.isJsActive),e.R7$(16),e.SpI(" ",e.i5U(92,30,"roles.guard",a.isJsActive),"\n"),e.R7$(4),e.AVh("hide",a.isJsActive),e.R7$(3),e.AVh("hide",!a.isJsActive),e.R7$(82),e.SpI(" ",e.i5U(181,33,"cats.controller",F.isJsActive),"\n"),e.R7$(4),e.AVh("hide",F.isJsActive),e.R7$(3),e.AVh("hide",!F.isJsActive)}},dependencies:[m.O,l.a,b.q,p.z,E.Wk,f.M],encapsulation:2,changeDetection:0})}return t})(),data:{title:"Autorisation"}}];let q=(()=>{class t{static \u0275fac=function(n){return new(n||t)};static \u0275mod=e.$C({type:t});static \u0275inj=e.G2t({imports:[g.MD,y.G,E.iI.forChild(A)]})}return t})()}}]);